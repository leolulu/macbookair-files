<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶è§†é¢‘ç¼©ç•¥å›¾é¢„è§ˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: row;
        }

        .preview-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            background: #1a1a1a;
        }

        .sidebar {
            width: 280px;
            background: #2d2d2d;
            padding: 15px;
            border-left: 1px solid #404040;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        .control-section {
            background: #3a3a3a;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #555555;
        }

        .sidebar h3 {
            font-size: 18px;
            margin: 0 0 15px 0;
            color: #007acc;
            text-align: center;
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-group label {
            font-size: 14px;
            color: #cccccc;
            display: block;
            margin-bottom: 5px;
        }

        .control-group input {
            background: #404040;
            border: 1px solid #555555;
            color: #ffffff;
            padding: 6px 8px;
            border-radius: 4px;
            width: 100%;
        }

        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            width: 100%;
        }

        .btn:hover {
            background: #005999;
        }

        .video-info {
            background: #333333;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

        .video-info strong {
            color: #00ff00;
            display: block;
            /* ä½¿æ–‡ä»¶åç‹¬å ä¸€è¡Œ */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            /* å…è®¸æ¢è¡Œ */
            word-wrap: break-word;
            /* é•¿å•è¯å¯ä»¥æ¢è¡Œ */
            word-break: break-all;
            /* å¼ºåˆ¶æ¢è¡Œ */
            line-height: 1.3;
            /* è®¾ç½®è¡Œé«˜ï¼Œä½¿å¤šè¡Œæ–‡æœ¬æ›´ç¾è§‚ */
            max-width: 100%;
            /* ç¡®ä¿ä¸ä¼šè¶…å‡ºå®¹å™¨ */
        }

        .video-info-details {
            font-size: 12px;
            color: #aaaaaa;
            margin-top: 5px;
        }

        .pagination {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pagination-buttons-row {
            display: flex;
            flex-direction: row;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }

        .pagination button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            flex: 1;
            /* Changed from width: 100% to flex: 1 */
            transition: all 0.2s ease;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .pagination button:hover:not(:disabled) {
            background: #F7C137;
            color: #2d2d2d;
            box-shadow: 0 2px 8px rgba(247, 193, 55, 0.4);
        }

        .pagination button:active:not(:disabled) {
            box-shadow: 0 1px 4px rgba(247, 193, 55, 0.3);
        }

        .pagination button:disabled {
            background: #666666;
            color: #cccccc;
            cursor: not-allowed;
        }


        .pagination-info {
            color: #cccccc;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
        }

        .time-range-display {
            color: #cccccc;
            font-size: 12px;
            text-align: center;
        }

        .page-number-display {
            color: #007acc;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            padding: 0 4px;
        }

        .page-indicator {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .page-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #555555;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .page-dot.active {
            background: #007acc;
        }

        .grid-size-display {
            color: #00ff00;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
        }

        .preview-container {
            width: 100%;
            height: 100%;
            max-width: 100%;
            position: relative;
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
        }

        .grid-item {
            position: relative;
            background: #000000;
            overflow: hidden;
            border: 1px solid #333333;
            cursor: pointer;
        }


        .grid-item video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* æ”¹ä¸ºcontainï¼Œä¿æŒè§†é¢‘å®Œæ•´æ˜¾ç¤º */
            background: #000;
            /* æ·»åŠ é»‘è‰²èƒŒæ™¯ï¼Œå¡«å……å¯èƒ½çš„ç©ºç™½åŒºåŸŸ */
            transform-origin: center center;
            cursor: grab;
            user-select: none;
            /* æ€§èƒ½ä¼˜åŒ–ï¼šå¯ç”¨GPUç¡¬ä»¶åŠ é€Ÿ */
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .grid-item video:active {
            cursor: grabbing;
        }

        .time-range-overlay {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .current-time-overlay {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #007acc;
            font-size: 18px;
        }

        .error {
            color: #ff6b6b;
            text-align: center;
            padding: 20px;
        }

        /* æ–°å¢CSSç±»ç”¨äºæ›¿ä»£å†…è”æ ·å¼ */
        .video-file-input {
            display: none;
        }

        .grid-input-row {
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .grid-input-row input {
            width: auto;
            flex: 1;
            -webkit-appearance: textfield;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* éšè—Webkitæµè§ˆå™¨çš„ç®­å¤´ */
        .grid-input-row input[type="number"]::-webkit-inner-spin-button,
        .grid-input-row input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* è‡ªå®šä¹‰å¢å‡æŒ‰é’®å®¹å™¨ */
        .number-controls {
            display: flex;
            margin-left: 8px;
            gap: 4px;
            align-items: center;
            align-self: center;
            position: relative;
            top: 1px;
        }

        /* å‚ç›´æŒ‰é’®ç»„ - å‚ç›´æ’åˆ—ï¼Œå›ºå®šé«˜åº¦60px */
        .number-controls.vertical {
            flex-direction: column;
            justify-content: center;
            height: 60px;
        }

        /* æ°´å¹³æŒ‰é’®ç»„ - æ°´å¹³æ’åˆ—ï¼Œå›ºå®šé«˜åº¦30px */
        .number-controls.horizontal {
            flex-direction: row;
            height: 30px;
        }

        /* è‡ªå®šä¹‰å¢å‡æŒ‰é’® */
        .number-btn {
            width: 28px;
            height: 28px;
            background: #4a4a4a;
            border: 1px solid #555555;
            color: #ffffff;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
            /* ç¡®ä¿æŒ‰é’®å†…å®¹å‚ç›´å±…ä¸­ */
            line-height: 1;
        }

        .number-btn:hover:not(:disabled) {
            background: #5a5a5a;
            border-color: #007acc;
        }

        .number-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .number-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .number-btn.both-btn {
            background: #4a5a4a;
        }

        .number-btn.both-btn:hover {
            background: #5a6a5a;
            border-color: #28a745;
        }

        .controls-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .number-controls:not(.both-controls) {
            flex-shrink: 0;
            margin-left: 8px;
        }

        .number-controls.both-controls {
            margin-left: auto;
            flex-shrink: 0;
        }

        /* ç½‘æ ¼è¾“å…¥è¡Œæ ‡ç­¾ä¼˜åŒ– */
        .grid-label {
            font-size: 12px;
            color: #aaaaaa;
            margin-right: 8px;
            min-width: 30px;
        }

        /* å®«æ ¼æ•°è¾“å…¥æ¡† */
        #gridSize,
        #gridSize2 {
            padding: 6px;
            text-align: center;
            font-size: 14px;
        }

        /* è¡Œæ•°è¾“å…¥æ¡† - è°ƒæ•´å®½åº¦ä»¥å®ç°å¯¹é½ */
        #gridSize {
            width: 40px;
            margin-right: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* åˆ—æ•°è¾“å…¥æ¡† - è°ƒæ•´å®½åº¦ */
        #gridSize2 {
            width: 40px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è¡Œåˆ—æ•°æ§åˆ¶åŒºåŸŸ */
        .grid-control-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .grid-control-row:last-child {
            margin-bottom: 0;
        }

        /* JavaScriptå†…è”æ ·å¼æ›¿ä»£ç±» */
        .video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .visible {
            display: block;
        }

        .hidden {
            display: none;
        }

        /* å¿«æ·æ—¶é—´æŒ‰é’®æ ·å¼ */
        .quick-time-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .quick-btn {
            background: #4a4a4a;
            color: #ffffff;
            border: 1px solid #555555;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            flex: 1;
            min-width: 45px;
        }

        .quick-btn:hover {
            background: #5a5a5a;
            border-color: #007acc;
        }

        .quick-btn.active {
            background: #007acc;
            border-color: #007acc;
            color: #ffffff;
        }

        /* æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #555555;
            border-radius: 4px;
            background: #2d2d2d;
        }

        .file-item {
            padding: 8px 12px;
            border-bottom: 1px solid #404040;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .file-item-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: #3a3a3a;
        }

        .file-item.active {
            background: #007acc;
            color: #ffffff;
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            /* æ”¹ä¸ºnormalï¼Œå…è®¸æ¢è¡Œ */
            word-wrap: break-word;
            /* é•¿å•è¯å¯ä»¥æ¢è¡Œ */
            word-break: break-all;
            /* å¼ºåˆ¶æ¢è¡Œ */
            font-size: 13px;
            min-width: 0;
            /* ç¡®ä¿flexå­å…ƒç´ å¯ä»¥æ”¶ç¼© */
            line-height: 1.3;
            /* è®¾ç½®è¡Œé«˜ï¼Œä½¿å¤šè¡Œæ–‡æœ¬æ›´ç¾è§‚ */
        }

        .file-remove {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 8px;
        }

        .file-remove:hover {
            background: #cc3333;
        }

        .file-info {
            font-size: 11px;
            color: #aaaaaa;
            margin-top: 2px;
        }

        .file-progress-wrapper {
            width: 100%;
            height: 6px;
            background: #404040;
            border-radius: 3px;
            margin-top: 4px;
            position: relative;
            overflow: hidden;
        }

        .file-progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #007acc;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        /* Unified progress fill style */
        #videoInfo .file-progress-fill {
            background: #F7C137;
            box-shadow: none;
        }

        .progress-indicator-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #00558e;
            z-index: 10;
            pointer-events: none;
            transition: left 0.1s ease;
            box-shadow: 0 0 4px rgba(255, 68, 68, 0.6);
            left: 0;
        }


        /* åŠ¨æ€ç½‘æ ¼å¸ƒå±€ç±» */
        .video-grid-dynamic {
            --grid-columns: 4;
            --grid-rows: 4;
            --row-height: 120px;
            grid-template-columns: repeat(var(--grid-columns), 1fr);
            grid-template-rows: repeat(var(--grid-rows), var(--row-height));
        }

        /* å›ºå®šçš„ç½‘æ ¼æ ·å¼ç±»ï¼Œå°†é€šè¿‡JavaScriptåŠ¨æ€ä¿®æ”¹ */
        #videoGrid {
            display: grid;
            width: 100%;
            height: 100%;
            gap: 2px;
            background: #000000;
        }

        /* é€šç”¨å·¥å…·ç±» */
        .is-hidden {
            display: none;
        }

        .spacing-bottom-sm {
            margin-bottom: 8px;
        }

        .layout-flex-center {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .layout-flex-center-tall {
            height: 60px;
        }

        .layout-flex-center-short {
            height: 30px;
        }

        .content-flex {
            flex: 1;
        }

        .hint-text {
            font-size: 12px;
            color: #888;
            text-align: center;
        }

        /* æ‹–æ”¾æ•ˆæœç±» */
        .btn.drag-over {
            background-color: #F7C137;
            transform: scale(1.05);
        }

        .btn.drag-leave {
            background-color: #007acc;
            transform: none;
        }

        /* Tab åˆ‡æ¢æ ·å¼ */
        .video-source-tabs {
            display: flex;
            border-bottom: 1px solid #555555;
            margin-bottom: 10px;
        }

        #video-source-tabs {
            margin-top: -10px;
        }

        .tab-button {
            background: transparent;
            color: #cccccc;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            flex: 1;
        }

        .tab-button:hover {
            color: #ffffff;
            background: rgba(0, 122, 204, 0.1);
        }

        .tab-button.active {
            color: #007acc;
            border-bottom-color: #007acc;
            background: rgba(0, 122, 204, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* æ–‡ä»¶åˆ—è¡¨åŒºåŸŸæ ·å¼è°ƒæ•´ */
        .file-list-section {
            margin-top: 10px;
            background: transparent;
            border: none;
            padding: 0;
        }

        .remote-url-input {
            width: 100%;
            margin-bottom: 8px;
            padding: 6px 8px;
            background: #404040;
            border: 1px solid #555555;
            color: #ffffff;
            border-radius: 4px;
        }

        /* é‡ç½®ç¼©æ”¾å’Œä½ç½®æŒ‰é’®æ ·å¼ */
        .btn-reset-transform {
            background: #F7C137;
            color: #2d2d2d;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
            font-weight: 500;
        }

        .btn-reset-transform:hover {
            background: #E5B02E;
            box-shadow: 0 2px 8px rgba(247, 193, 55, 0.4);
        }

        .btn-reset-transform:active {
            box-shadow: 0 1px 4px rgba(247, 193, 55, 0.3);
        }

        /* å¼ºåˆ¶æ¸…ç†å†…å­˜æŒ‰é’®æ ·å¼ */
        .btn-force-cleanup {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
            font-weight: 500;
        }

        .btn-force-cleanup:hover {
            background: #ff5252;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
        }

        .btn-force-cleanup:active {
            box-shadow: 0 1px 4px rgba(255, 107, 107, 0.3);
        }
    </style>
</head>

<body>
    <!-- å·¦ä¾§é¢„è§ˆåŒºåŸŸ -->
    <div class="preview-area">
        <div class="preview-container" id="previewContainer">
            <div class="loading" id="loading">æ­£åœ¨åŠ è½½è§†é¢‘...</div>
            <div class="video-grid-dynamic" id="videoGrid"></div>
        </div>
    </div>

    <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="sidebar">
        <!-- è§†é¢‘æºé€‰æ‹©åŒºåŸŸ -->
        <div class="control-section">
            <div class="video-source-tabs" id="video-source-tabs">
                <button class="tab-button active" onclick="switchTab('local')">æœ¬åœ°è§†é¢‘</button>
                <button class="tab-button" onclick="switchTab('remote')">è¿œç¨‹è§†é¢‘</button>
            </div>

            <!-- æœ¬åœ°è§†é¢‘ Tab å†…å®¹ -->
            <div id="localTab" class="tab-content active">
                <div class="control-group">
                    <button class="btn" onclick="selectVideo()">é€‰æ‹©è§†é¢‘</button>
                    <input type="file" id="videoFile" accept="video/*" multiple class="video-file-input">
                </div>
            </div>

            <!-- è¿œç¨‹è§†é¢‘ Tab å†…å®¹ -->
            <div id="remoteTab" class="tab-content">
                <div class="control-group">
                    <input type="url" id="remoteUrlInput" placeholder="è§†é¢‘URL" class="remote-url-input"
                        onkeypress="handleRemoteUrlKeyPress(event)" ondblclick="clearRemoteUrlInput()">
                    <button class="btn"
                        onclick="app.loadRemoteVideo(document.getElementById('remoteUrlInput').value)">ç¡®è®¤åŠ è½½è¿œç¨‹è§†é¢‘</button>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ -->
        <div class="control-section is-hidden file-list-section" id="fileListSection">
            <div class="control-group">
                <label>å·²é€‰æ‹©çš„è§†é¢‘æ–‡ä»¶:</label>
                <div class="file-list" id="fileList"></div>
            </div>
        </div>

        <div class="video-info hidden" id="videoInfo">
            <div class="video-info-name"><strong id="videoName"></strong></div>
            <div class="video-info-details">
                æ—¶é•¿: <span id="videoDuration"></span><br>
                åˆ†è¾¨ç‡: <span id="videoResolution"></span>
            </div>
            <!-- ç»Ÿä¸€çš„è¿›åº¦æ¡å®¹å™¨ -->
            <div id="unifiedProgressBarContainer" style="margin-top: 8px; min-height: 8px;"></div>
        </div>

        <div class="pagination hidden" id="pagination">
            <div class="pagination-buttons-row">
                <button onclick="app.previousPage()">ä¸Šä¸€é¡µ</button>
                <button onclick="app.nextPage()">ä¸‹ä¸€é¡µ</button>
            </div>
            <div class="pagination-info" id="pageInfo">1 / 1</div>
            <div class="hint-text">
                â†â†‘ä¸Šä¸€é¡µ | â†’â†“ä¸‹ä¸€é¡µ
            </div>
            <div class="page-indicator" id="pageIndicator"></div>
        </div>

        <div class="control-section">
            <div class="control-group">
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="autoCalculateCols" onchange="toggleAutoCalculateCols()"
                        style="width: 16px; height: 16px;">
                    <span style="font-size: 14px; color: #cccccc;">è‡ªåŠ¨è®¡ç®—åˆ—æ•°</span>
                </label>
                <div class="spacing-bottom-sm">
                    <div class="grid-control-row">
                        <span class="grid-label">è¡Œæ•°:</span>
                        <div class="layout-flex-center layout-flex-center-tall">
                            <input type="number" id="gridSize" min="1" max="6" value="4" onchange="updateGrid()">
                            <div class="controls-wrapper">
                                <div class="number-controls vertical">
                                    <div class="number-btn" onclick="changeGridSize(1, 1)">â–²</div>
                                    <div class="number-btn" onclick="changeGridSize(1, -1)">â–¼</div>
                                </div>
                                <div class="number-controls both-controls">
                                    <div class="number-btn both-btn" onclick="changeBothGridSize(1)">âŠ•</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid-control-row">
                        <span class="grid-label">åˆ—æ•°:</span>
                        <div class="layout-flex-center layout-flex-center-short">
                            <input type="number" id="gridSize2" min="1" max="6" value="4" onchange="updateGrid()">
                            <div class="controls-wrapper">
                                <div class="number-controls horizontal">
                                    <div class="number-btn" onclick="changeGridSize(2, -1)">â—„</div>
                                    <div class="number-btn" onclick="changeGridSize(2, 1)">â–º</div>
                                </div>
                                <div class="number-controls both-controls">
                                    <div class="number-btn both-btn" onclick="changeBothGridSize(-1)">âŠ–</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid-size-display" id="gridDisplay">4Ã—4 = 16ä¸ª</div>
        </div>

        <div class="control-section">
            <div class="control-group">
                <label>æ¯æ ¼æ—¶é•¿(ç§’):</label>
                <input type="number" id="duration" min="1" max="300" value="30" onchange="updatePreview()">
            </div>
            <div class="control-group">
                <label>å¿«æ·é€‰æ‹©:</label>
                <div class="quick-time-buttons">
                    <button class="quick-btn" onclick="setDuration(2)">2ç§’</button>
                    <button class="quick-btn" onclick="setDuration(5)">5ç§’</button>
                    <button class="quick-btn" onclick="setDuration(10)">10ç§’</button>
                    <button class="quick-btn" onclick="setDuration(20)">20ç§’</button>
                    <button class="quick-btn" onclick="setDuration(30)">30ç§’</button>
                    <button class="quick-btn" onclick="setDuration(60)">60ç§’</button>
                    <button class="quick-btn" onclick="setDuration(120)">2åˆ†é’Ÿ</button>
                    <button class="quick-btn" onclick="setDuration(180)">3åˆ†é’Ÿ</button>
                </div>
            </div>
        </div>

        <div class="control-section" style="padding: 8px 12px;">
            <div class="control-group" style="margin-bottom: 0;">
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0; cursor: pointer;">
                    <input type="checkbox" id="remoteVideoOptimization" style="width: 16px; height: 16px;">
                    <span style="font-size: 14px; color: #cccccc;">è¿œç¨‹è§†é¢‘ç¿»é¡µä¸é‡ç»˜</span>
                </label>
            </div>
            <div class="control-group" style="margin-bottom: 0; margin-top: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0; cursor: pointer;">
                    <input type="checkbox" id="enablePreloading" onchange="app.togglePreloading()" checked
                        style="width: 16px; height: 16px;">
                    <span style="font-size: 14px; color: #cccccc;">å¯ç”¨è¿œç¨‹è§†é¢‘é¢„åŠ è½½</span>
                </label>
                <!-- é¢„åŠ è½½çŠ¶æ€æ˜¾ç¤º -->
                <div id="preloadingStatus"
                    style="margin-top: 5px; margin-left: 24px; font-size: 12px; color: #F7C137; display: none;">
                    â³ ç­‰å¾…é¢„åŠ è½½...
                </div>
            </div>
        </div>

        <div class="control-section is-hidden" id="resetTransformSection">
            <div class="control-group">
                <button class="btn-reset-transform" onclick="app.resetVideoTransform()">é‡ç½®ç¼©æ”¾å’Œä½ç½®</button>
                <div class="hint-text" style="margin-top: 5px;">
                    å°†æ‰€æœ‰æ ¼å­çš„ç¼©æ”¾å’Œä½ç½®æ¢å¤åˆ°åˆå§‹çŠ¶æ€
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="control-group">
                <button class="btn-force-cleanup" onclick="app.forceCleanup()">å¼ºåˆ¶æ¸…ç†å†…å­˜</button>
                <div class="hint-text" style="margin-top: 5px;">
                    å¦‚æœæ„Ÿè§‰å†…å­˜å ç”¨è¿‡é«˜ï¼Œç‚¹å‡»æ­¤æŒ‰é’®é‡Šæ”¾èµ„æº
                </div>
            </div>
        </div>
    </div>

    <script>
        class VideoThumbnailPreview {
            constructor() {
                this.currentVideo = null;
                this.originalVideo = null;
                this.currentVideoUrl = null;
                this.isLoading = false;
                this.currentPage = 0;
                this.totalPages = 0;

                // è®°å½•å½“å‰é¡µé¢å·¦ä¸Šè§’ç¬¬ä¸€ä¸ªæ ¼å­çš„èµ·å§‹æ—¶é—´
                this.currentStartTime = 0;

                // å¤šæ–‡ä»¶æ”¯æŒçŠ¶æ€
                this.videoFiles = [];
                this.currentVideoIndex = 0;

                // å…¨å±€è§†é¢‘ç¼©æ”¾å’Œæ‹–åŠ¨çŠ¶æ€ï¼ˆæ‰€æœ‰æ ¼å­å…±äº«ï¼‰
                this.videoScale = 1;
                this.videoTranslateX = 0;
                this.videoTranslateY = 0;
                this.isDragging = false;
                this.dragStartX = 0;
                this.dragStartY = 0;
                this.hasMoved = false;
                this.hasTransformed = false; // æ ‡è®°æ˜¯å¦å‘ç”Ÿè¿‡ç¼©æ”¾æˆ–æ‹–åŠ¨

                // èµ„æºè·Ÿè¸ª
                this.createdURLs = new Set();
                this.createdVideos = [];
                this.eventListeners = [];

                // æ ¼å­çŠ¶æ€è·Ÿè¸ª
                this.cellLoadedCount = 0;  // å·²è¿›å…¥"åŠ è½½ä¸­"çŠ¶æ€çš„æ ¼å­æ•°é‡
                this.cellPlayingCount = 0; // å·²è¿›å…¥"æ’­æ”¾ä¸­"çŠ¶æ€çš„æ ¼å­æ•°é‡
                this.totalCellsInCurrentPage = 0; // å½“å‰é¡µé¢çš„æ ¼å­æ€»æ•°

                // é¢„åŠ è½½æœºåˆ¶ - ä»…ç”¨äºè¿œç¨‹è§†é¢‘
                this.preloadedVideos = [];  // å­˜å‚¨é¢„åŠ è½½çš„videoå…ƒç´ ï¼ˆä¸æ’å…¥DOMï¼‰

                // ç½‘æ ¼çŠ¶æ€è·Ÿè¸ª - ç”¨äºä¼˜åŒ–é¡µé¢åˆ‡æ¢
                this.gridState = {
                    isInitialized: false,
                    rows: 0,
                    cols: 0,
                    totalCells: 0,
                    cellDuration: 0,
                    videoFile: null
                };

                // é¢„åŠ è½½æ§åˆ¶å™¨
                this.preloadAbortController = null;

                // é˜²æŠ–æœºåˆ¶
                this.updatePreviewDebounced = this.debounce(this.updatePreview.bind(this), 300);
                this.loadVideoDebounced = this.debounce(this.loadVideo.bind(this), 500);

                // å†…å­˜ç›‘æ§
                this.memoryMonitorInterval = null;
                this.startMemoryMonitoring();

                this.updateGridDisplay();
                this.initDragAndDrop();
                this.initKeyboardEvents();
                this.initWindowResizeListener();
                // ç§»é™¤å‰ªè´´æ¿ç›‘å¬åŠŸèƒ½

                // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
                window.addEventListener('beforeunload', () => this.cleanupAllResources());

                // å…¨å±€é”™è¯¯æ•è·
                this.initGlobalErrorHandling();

                // å¯åŠ¨è§†é¢‘æ’­æ”¾çŠ¶æ€æ£€æµ‹å™¨
                this.startVideoPlayMonitor();

                // é”™è¯¯é€šçŸ¥ç®¡ç†
                this.lastErrorNotification = 0;
                this.errorNotificationCount = 0;
                this.lastErrorMessage = '';
            }

            // é˜²æŠ–å‡½æ•°
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // å¼€å§‹å†…å­˜ç›‘æ§
            startMemoryMonitoring() {
                const logMemoryUsage = () => {
                    if (performance.memory) {
                        const memory = performance.memory;
                        const usagePercent = (memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100;
                        if (usagePercent > 80) {
                            console.warn(`âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${usagePercent.toFixed(1)}%ï¼Œå»ºè®®ç‚¹å‡»"å¼ºåˆ¶æ¸…ç†å†…å­˜"æŒ‰é’®`);
                        }
                    }
                };

                // æ¯5ç§’è®°å½•ä¸€æ¬¡
                this.memoryMonitorInterval = setInterval(logMemoryUsage, 5000);
            }

            // åœæ­¢å†…å­˜ç›‘æ§
            stopMemoryMonitoring() {
                if (this.memoryMonitorInterval) {
                    clearInterval(this.memoryMonitorInterval);
                    this.memoryMonitorInterval = null;
                }
            }

            // å¯åŠ¨è§†é¢‘æ’­æ”¾çŠ¶æ€æ£€æµ‹å™¨
            startVideoPlayMonitor() {
                // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰è§†é¢‘çš„æ’­æ”¾çŠ¶æ€
                this.playMonitorInterval = setInterval(() => {
                    this.checkVideosPlayState();
                }, 10000);
            }

            // åœæ­¢è§†é¢‘æ’­æ”¾çŠ¶æ€æ£€æµ‹å™¨
            stopVideoPlayMonitor() {
                if (this.playMonitorInterval) {
                    clearInterval(this.playMonitorInterval);
                    this.playMonitorInterval = null;
                }
            }

            // æ£€æŸ¥æ‰€æœ‰è§†é¢‘çš„æ’­æ”¾çŠ¶æ€
            checkVideosPlayState() {
                // è·³è¿‡originalVideo (index=0)ï¼Œåªæ£€æŸ¥ç¼©ç•¥å›¾è§†é¢‘
                this.createdVideos.forEach((video, index) => {
                    if (index === 0) return; // è·³è¿‡originalVideo

                    try {
                        // æ£€æŸ¥è§†é¢‘æ˜¯å¦æš‚åœæˆ–å¡ä½
                        if (!video || !video.readyState || video.readyState < 2) {
                            // è§†é¢‘æœªå‡†å¤‡å¥½ï¼Œè·³è¿‡
                            return;
                        }

                        // æ£€æŸ¥è§†é¢‘æ˜¯å¦æš‚åœ
                        if (video.paused || video.ended) {
                            console.log(`æ£€æµ‹åˆ°è§†é¢‘æš‚åœï¼Œå°è¯•æ¢å¤æ’­æ”¾: æ ¼å­${index - 1}`);
                            video.play().catch(e => {
                                console.log(`è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:`, e);
                                // å¦‚æœæ’­æ”¾è¢«é˜»æ­¢ï¼Œå°è¯•é€šè¿‡ç”¨æˆ·äº¤äº’æ–¹å¼è§¦å‘
                                this.requestPlayPermission(video);
                            });
                            return;
                        }

                        // æ£€æŸ¥è§†é¢‘æ˜¯å¦å¡ä½ï¼ˆå½“å‰æ—¶é—´æ²¡æœ‰å˜åŒ–ï¼‰
                        const currentTime = video.currentTime;
                        if (typeof video._lastCheckTime !== 'undefined' &&
                            Math.abs(currentTime - video._lastCheckTime) < 0.01) {
                            // æ—¶é—´æ²¡æœ‰å˜åŒ–ï¼Œå¯èƒ½æ˜¯å¡ä½äº†
                            console.log(`æ£€æµ‹åˆ°è§†é¢‘å¡ä½ï¼Œå°è¯•é‡æ–°æ’­æ”¾: æ ¼å­${index - 1}`);
                            video.play().catch(e => {
                                console.log(`é‡æ–°æ’­æ”¾è¢«é˜»æ­¢:`, e);
                                this.requestPlayPermission(video);
                            });
                        }

                        // æ›´æ–°ä¸Šæ¬¡æ£€æŸ¥çš„æ—¶é—´
                        video._lastCheckTime = currentTime;

                    } catch (e) {
                        console.error(`æ£€æŸ¥è§†é¢‘æ’­æ”¾çŠ¶æ€å¤±è´¥:`, e);
                    }
                });
            }

            // è¯·æ±‚æ’­æ”¾æƒé™ï¼ˆé€šè¿‡æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’ï¼‰
            requestPlayPermission(video) {
                // å°è¯•é€šè¿‡é™éŸ³æ¥è·å¾—æ’­æ”¾æƒé™
                if (video.muted === false) {
                    video.muted = true;
                    video.play().then(() => {
                        // æ’­æ”¾æˆåŠŸåæ¢å¤é™éŸ³çŠ¶æ€
                        video.muted = false;
                    }).catch(e => {
                        console.log(`é™éŸ³æ’­æ”¾ä¹Ÿå¤±è´¥:`, e);
                    });
                }
            }

            // æ¸…ç†æ‰€æœ‰èµ„æº
            cleanupAllResources() {
                this.stopMemoryMonitoring();
                this.stopVideoPlayMonitor();
                this.cleanupVideos();
                this.cleanupPreloadedVideos();  // æ¸…ç†é¢„åŠ è½½è§†é¢‘
                this.cleanupURLs();
                this.cleanupEventListeners();
                this.cleanupCaches();
            }

            // æ¸…ç†è§†é¢‘å…ƒç´ 
            cleanupVideos() {
                // åœæ­¢è¿›åº¦æ ‡è¯†çº¿æ›´æ–°
                this.stopProgressIndicator();

                this.createdVideos.forEach(video => {
                    try {
                        video.pause();
                        video.src = '';
                        video.load();
                        if (video.parentNode) {
                            video.parentNode.removeChild(video);
                        }
                    } catch (e) {
                        console.error('æ¸…ç†è§†é¢‘å…ƒç´ å¤±è´¥:', e);
                    }
                });
                this.createdVideos = [];
            }

            // æ¸…ç†é¢„åŠ è½½çš„è§†é¢‘å…ƒç´ ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
            cleanupPreloadedVideos() {
                // 1. å–æ¶ˆæ‰€æœ‰æŒ‚èµ·çš„äº‹ä»¶ç›‘å¬å™¨
                if (this.preloadAbortController) {
                    console.log('ğŸ›‘ Aborting preloading...');
                    this.preloadAbortController.abort();
                    this.preloadAbortController = null;
                }

                // éšè—é¢„åŠ è½½çŠ¶æ€
                const statusEl = document.getElementById('preloadingStatus');
                if (statusEl) {
                    statusEl.style.display = 'none';
                    statusEl.textContent = '';
                }

                if (this.preloadedVideos.length > 0) {
                    this.preloadedVideos.forEach(video => {
                        try {
                            video.pause();
                            video.src = '';
                            video.load();
                            video.remove();
                        } catch (e) {
                            console.error('æ¸…ç†é¢„åŠ è½½è§†é¢‘å…ƒç´ å¤±è´¥:', e);
                        }
                    });
                    this.preloadedVideos = [];
                }
            }

            // æ¸…ç†URLå¯¹è±¡
            cleanupURLs() {
                this.createdURLs.forEach(url => {
                    try {
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        console.error('æ¸…ç†URLå¯¹è±¡å¤±è´¥:', e);
                    }
                });
                this.createdURLs.clear();
            }

            // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            cleanupEventListeners() {
                // æ¸…ç† document çº§åˆ«äº‹ä»¶ç›‘å¬å™¨
                this.removeDocumentLevelEventListeners();

                this.eventListeners.forEach(({ element, event, handler }) => {
                    try {
                        element.removeEventListener(event, handler);
                    } catch (e) {
                        console.error('æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', e);
                    }
                });
                this.eventListeners = [];
            }

            // æ¸…ç†ç¼“å­˜
            cleanupCaches() {
                // æ¸…ç†æ—¶é—´æ ¼å¼åŒ–ç¼“å­˜
                if (this._timeFormatCache) {
                    this._timeFormatCache.clear();
                }

                // æ¸…ç†é¡µé¢é…ç½®ç¼“å­˜
                this._cachedPageConfig = null;
            }

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨å¹¶è·Ÿè¸ª
            addTrackedEventListener(element, event, handler) {
                element.addEventListener(event, handler);
                this.eventListeners.push({ element, event, handler });
            }

            // åˆå§‹åŒ–é”®ç›˜äº‹ä»¶
            initKeyboardEvents() {
                document.addEventListener('keydown', (e) => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰è¾“å…¥æ¡†è·å¾—äº†ç„¦ç‚¹
                    if (document.activeElement &&
                        (document.activeElement.tagName === 'INPUT' ||
                            document.activeElement.tagName === 'TEXTAREA')) {
                        return; // å¦‚æœæ­£åœ¨è¾“å…¥ï¼Œè·³è¿‡é”®ç›˜äº‹ä»¶
                    }

                    switch (e.key) {
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            e.preventDefault();
                            this.previousPage();
                            break;
                        case 'ArrowRight':
                        case 'ArrowDown':
                            e.preventDefault();
                            this.nextPage();
                            break;
                    }
                });
            }

            // åˆå§‹åŒ–çª—å£å¤§å°æ”¹å˜ç›‘å¬
            initWindowResizeListener() {
                window.addEventListener('resize', () => {
                    // ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹è®¡ç®—
                    if (this.resizeTimeout) {
                        clearTimeout(this.resizeTimeout);
                    }
                    this.resizeTimeout = setTimeout(() => {
                        const checkbox = document.getElementById('autoCalculateCols');
                        if (checkbox && checkbox.checked && this.originalVideo) {
                            calculateAndSetCols();
                            updateGrid();
                        }
                    }, 300);
                });
            }

            // åˆå§‹åŒ–æ‹–æ”¾åŠŸèƒ½
            initDragAndDrop() {
                const dropZone = document.getElementById('videoFile');
                const button = document.querySelector('.btn');

                [dropZone, button].forEach(element => {
                    element.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        button.classList.add('drag-over');
                        button.classList.remove('drag-leave');
                        e.dataTransfer.dropEffect = 'copy';
                    });

                    element.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        button.classList.remove('drag-over');
                        button.classList.add('drag-leave');
                        setTimeout(() => button.classList.remove('drag-leave'), 200);
                    });

                    element.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        button.classList.remove('drag-over');
                        button.classList.remove('drag-leave');

                        const files = Array.from(e.dataTransfer.files);
                        if (files.length > 0) {
                            // å¤„ç†å¤šæ–‡ä»¶æ‹–æ”¾
                            this.videoFiles = files;
                            this.currentVideoIndex = 0;
                            this.currentVideo = this.videoFiles[0];

                            this.updateFileList();
                            await this.loadVideo();
                        }
                    });
                });
            }

            async selectVideo() {
                try {
                    const input = document.getElementById('videoFile');
                    input.click();

                    return new Promise((resolve, reject) => {
                        input.onchange = async (e) => {
                            if (e.target.files.length > 0) {
                                // å°†é€‰æ‹©çš„æ–‡ä»¶æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
                                this.videoFiles = Array.from(e.target.files);
                                this.currentVideoIndex = 0;
                                this.currentVideo = this.videoFiles[0];

                                // æ›´æ–°æ–‡ä»¶åˆ—è¡¨UI
                                this.updateFileList();

                                // åŠ è½½ç¬¬ä¸€ä¸ªè§†é¢‘
                                await this.loadVideo();
                                resolve();
                            } else {
                                resolve();
                            }
                        };
                    });
                } catch (error) {
                    console.error('æ–‡ä»¶é€‰æ‹©å¤±è´¥:', error);
                    this.showError('æ–‡ä»¶é€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }

            async loadVideo() {
                if (!this.currentVideo) return;

                this.currentVideoUrl = null;

                // é‡ç½®åˆ†é¡µçŠ¶æ€ï¼Œç¡®ä¿æ–°è§†é¢‘ä»ç¬¬ä¸€é¡µå¼€å§‹
                this.currentPage = 0;
                this.totalPages = 0;
                this.currentStartTime = 0;

                // é‡ç½®ç½‘æ ¼çŠ¶æ€ï¼Œå¼ºåˆ¶é‡æ–°åˆ›å»ºç½‘æ ¼
                this.resetGridState();

                // æ¸…ç†ç¼“å­˜ï¼Œé¿å…æ—§æ•°æ®å½±å“æ–°è§†é¢‘
                this.cleanupCaches();

                this.isLoading = true;
                this.showLoading(true);
                this.clearError();

                // æ¸…ç†ä¹‹å‰çš„èµ„æº
                this.cleanupVideos();
                this.cleanupPreloadedVideos();  // æ¸…ç†é¢„åŠ è½½è§†é¢‘
                this.cleanupURLs();

                try {
                    const videoURL = URL.createObjectURL(this.currentVideo);
                    this.createdURLs.add(videoURL);

                    const video = document.createElement('video');
                    this.createdVideos.push(video);

                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = resolve;
                        video.onerror = reject;
                        video.src = videoURL;
                    });

                    this.originalVideo = video;
                    this.updateVideoInfo();
                    // ç¡®ä¿åœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ä¹Ÿæ­£ç¡®åº”ç”¨ç¼©æ”¾è®¡ç®—
                    setTimeout(() => {
                        this.updatePreview();
                    }, 0);

                    // å¯åŠ¨å‚ç›´è¿›åº¦æ ‡è¯†çº¿æ›´æ–°
                    this.startProgressIndicator();
                } catch (error) {
                    console.error('è§†é¢‘åŠ è½½å¤±è´¥:', error);
                    this.showError('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                    this.showNotification('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', true);
                } finally {
                    this.isLoading = false;
                    this.showLoading(false);
                }
            }

            // é˜²æŠ–ç‰ˆæœ¬çš„è§†é¢‘åŠ è½½
            loadVideoDebouncedWrapper() {
                this.loadVideoDebounced();
            }

            updateVideoInfo() {
                const video = this.originalVideo;
                const duration = this.formatTime(video.duration);
                const resolution = `${video.videoWidth}Ã—${video.videoHeight}`;

                const nameEl = document.getElementById('videoName');
                if (this.currentVideoUrl) {
                    nameEl.textContent = `è¿œç¨‹è§†é¢‘: ${this.currentVideoUrl}`;
                } else if (this.currentVideo) {
                    nameEl.textContent = this.currentVideo.name;
                } else {
                    nameEl.textContent = 'æ— è§†é¢‘';
                }

                document.getElementById('videoDuration').textContent = duration;
                document.getElementById('videoResolution').textContent = resolution;
                document.getElementById('videoInfo').classList.remove('hidden');
                document.getElementById('videoInfo').classList.add('visible');

                // ä¸ºå½“å‰è§†é¢‘ï¼ˆæœ¬åœ°æˆ–è¿œç¨‹ï¼‰åˆ›å»ºæˆ–æ›´æ–°è¿›åº¦æ¡
                this.createOrUpdateProgressBar();

                // ç«‹å³æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
                this.updateFileProgress();

                // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨è®¡ç®—åˆ—æ•°ï¼Œåœ¨è§†é¢‘åŠ è½½åé‡æ–°è®¡ç®—
                const checkbox = document.getElementById('autoCalculateCols');
                if (checkbox && checkbox.checked) {
                    calculateAndSetCols();
                }
            }

            async updatePreview() {
                if (!this.originalVideo) return;

                this.isLoading = true;
                this.showLoading(true);

                try {
                    updateQuickButtons(); // æ›´æ–°å¿«æ·æŒ‰é’®çŠ¶æ€

                    // ä¿å­˜å½“å‰çš„èµ·å§‹æ—¶é—´ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è®¾ç½®çš„è¯ï¼‰
                    if (this.currentStartTime === 0 && this.currentPage > 0) {
                        const { pageDuration } = this.getPageConfig();
                        this.currentStartTime = this.currentPage * pageDuration;
                    }

                    this.calculatePages();
                    this.updatePaginationUI();
                    this.renderGrid();
                    this.updateFileProgress();
                } catch (error) {
                    console.error('é¢„è§ˆæ›´æ–°å¤±è´¥:', error);
                    this.showError('é¢„è§ˆæ›´æ–°å¤±è´¥');
                    this.showNotification('é¢„è§ˆæ›´æ–°å¤±è´¥', true);
                } finally {
                    this.isLoading = false;
                    this.showLoading(false);
                }
            }

            // é˜²æŠ–ç‰ˆæœ¬çš„é¢„è§ˆæ›´æ–°
            updatePreviewDebouncedWrapper() {
                this.updatePreviewDebounced();
            }

            // è·å–é¡µé¢é…ç½®å‚æ•°
            getPageConfig() {
                const rows = parseInt(document.getElementById('gridSize').value);
                const cols = parseInt(document.getElementById('gridSize2').value);
                const cellDuration = parseInt(document.getElementById('duration').value);
                const totalCells = rows * cols;
                const pageDuration = totalCells * cellDuration;
                return { rows, cols, cellDuration, totalCells, pageDuration };
            }

            // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ›å»ºç½‘æ ¼
            needToRecreateGrid() {
                const { rows, cols, cellDuration, totalCells } = this.getPageConfig();

                // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è¿œç¨‹è§†é¢‘ç¿»é¡µä¼˜åŒ–
                const remoteOptimizationCheckbox = document.getElementById('remoteVideoOptimization');
                const remoteOptimizationEnabled = remoteOptimizationCheckbox && remoteOptimizationCheckbox.checked;

                // å¦‚æœå¯ç”¨äº†è¿œç¨‹è§†é¢‘ä¼˜åŒ–ï¼Œä¸”åªæ˜¯è¿œç¨‹è§†é¢‘ï¼Œåˆ™ä¸å¼ºåˆ¶é‡å»º
                const shouldForceRebuildForRemote = this.currentVideoUrl && !remoteOptimizationEnabled;

                return !this.gridState.isInitialized ||
                    this.gridState.rows !== rows ||
                    this.gridState.cols !== cols ||
                    this.gridState.cellDuration !== cellDuration ||
                    this.gridState.totalCells !== totalCells ||
                    this.gridState.videoFile !== this.currentVideo ||
                    shouldForceRebuildForRemote;  // è¿œç¨‹è§†é¢‘æ ¹æ®ä¼˜åŒ–è®¾ç½®å†³å®šæ˜¯å¦é‡å»º
            }

            // æ›´æ–°ç½‘æ ¼çŠ¶æ€
            updateGridState() {
                const { rows, cols, cellDuration, totalCells } = this.getPageConfig();

                this.gridState = {
                    isInitialized: true,
                    rows,
                    cols,
                    totalCells,
                    cellDuration,
                    videoFile: this.currentVideo
                };
            }

            // é‡ç½®ç½‘æ ¼çŠ¶æ€
            resetGridState() {
                this.gridState = {
                    isInitialized: false,
                    rows: 0,
                    cols: 0,
                    totalCells: 0,
                    cellDuration: 0,
                    videoFile: null
                };
                // é‡ç½®ç¼©æ”¾å’Œæ‹–åŠ¨çŠ¶æ€
                this.videoScale = 1;
                this.videoTranslateX = 0;
                this.videoTranslateY = 0;
            }

            calculatePages() {
                const { rows, cols, cellDuration, totalCells, pageDuration } = this.getPageConfig();
                const videoDuration = this.originalVideo.duration;

                // ç¡®ä¿æ•°å€¼æœ‰æ•ˆæ€§
                if (!videoDuration || videoDuration <= 0 || pageDuration <= 0) {
                    this.totalPages = 1;
                    this.currentPage = 0;
                    this.currentStartTime = 0;
                    return;
                }

                this.totalPages = Math.ceil(videoDuration / pageDuration);

                // ä¿åº•é˜²æ­¢èµ·å§‹æ—¶é—´å˜æˆè´Ÿæ•°ï¼Œç¡®ä¿ç¬¬ä¸€é¡µçš„ç¬¬ä¸€ä¸ªæ ¼å­ä»0ç§’å¼€å§‹
                this.currentStartTime = Math.max(0, this.currentStartTime);

                // ç¡®ä¿é¡µç è®¡ç®—çš„ä¸€è‡´æ€§ï¼Œä½¿ç”¨æµ®ç‚¹æ•°ç²¾åº¦å¤„ç†
                this.currentPage = Math.max(0, Math.min(Math.floor(this.currentStartTime / pageDuration), this.totalPages - 1));

                // å¦‚æœå½“å‰é¡µé¢å†…å®¹è¦†ç›–åˆ°è§†é¢‘æœ«å°¾ï¼ˆæµ®ç‚¹å®¹å·®ï¼‰ï¼Œå¼ºåˆ¶è®¾ä¸ºæœ€åä¸€é¡µ
                if (this.currentStartTime + pageDuration >= videoDuration - 0.1) {
                    this.currentPage = this.totalPages - 1;
                }
            }

            updatePaginationUI() {
                const pagination = document.getElementById('pagination');
                const pageIndicator = document.getElementById('pageIndicator');
                const pageInfo = document.getElementById('pageInfo');

                if (this.totalPages > 1) {
                    pagination.classList.remove('hidden');
                    pagination.classList.add('visible');

                    // åªåœ¨é¡µæ•°å˜åŒ–æ—¶é‡æ–°åˆ›å»ºé¡µé¢æŒ‡ç¤ºå™¨
                    if (pageIndicator.children.length !== this.totalPages) {
                        pageIndicator.innerHTML = '';
                        for (let i = 0; i < this.totalPages; i++) {
                            const dot = document.createElement('div');
                            dot.className = 'page-dot';
                            dot.onclick = () => this.goToPage(i);
                            pageIndicator.appendChild(dot);
                        }
                    }

                    // æ›´æ–°é¡µé¢æŒ‡ç¤ºå™¨çš„æ¿€æ´»çŠ¶æ€
                    const dots = pageIndicator.querySelectorAll('.page-dot');
                    dots.forEach((dot, index) => {
                        dot.classList.toggle('active', index === this.currentPage);
                    });

                    // æ›´æ–°æŒ‰é’®disabledçŠ¶æ€
                    const prevBtn = pagination.querySelector('button:nth-child(1)');
                    const nextBtn = pagination.querySelector('button:nth-child(2)');
                    const { pageDuration } = this.getPageConfig();
                    const videoDuration = this.originalVideo ? this.originalVideo.duration : 0;
                    if (prevBtn) prevBtn.disabled = this.currentStartTime <= 0;
                    if (nextBtn) nextBtn.disabled = (this.currentStartTime + pageDuration >= videoDuration - 0.1);

                    // ç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
                    if (!this._cachedPageConfig ||
                        this._cachedPageConfig.pageDuration !== this.getPageConfig().pageDuration ||
                        this._cachedPageConfig.videoDuration !== this.originalVideo.duration ||
                        this._cachedPageConfig.currentStartTime !== this.currentStartTime) {

                        const { pageDuration } = this.getPageConfig();
                        const videoDuration = this.originalVideo.duration;
                        const endTime = Math.min(this.currentStartTime + pageDuration, videoDuration);

                        this._cachedPageConfig = {
                            pageDuration,
                            videoDuration,
                            currentStartTime: this.currentStartTime,
                            startMin: (this.currentStartTime / 60).toFixed(1),
                            endMin: (endTime / 60).toFixed(1),
                            totalMin: (videoDuration / 60).toFixed(1)
                        };
                    }

                    // åŒæ—¶æ˜¾ç¤ºæ—¶é—´èŒƒå›´å’Œé¡µç ä¿¡æ¯
                    const timeRangeText = `${this._cachedPageConfig.startMin}~${this._cachedPageConfig.endMin} / ${this._cachedPageConfig.totalMin}`;
                    const pageText = `${this.currentPage + 1} / ${this.totalPages}`;
                    pageInfo.innerHTML = `
                        <div class="time-range-display">${timeRangeText}</div>
                        <div class="page-number-display">${pageText}</div>
                    `;
                } else {
                    pagination.classList.add('hidden');
                    pagination.classList.remove('visible');
                }
            }

            goToPage(pageIndex) {
                if (pageIndex >= 0 && pageIndex < this.totalPages) {
                    // æ¸…ç†é¢„åŠ è½½çš„è§†é¢‘å…ƒç´ 
                    this.cleanupPreloadedVideos();

                    this.currentPage = pageIndex;
                    // æ›´æ–°èµ·å§‹æ—¶é—´ä¸ºæ–°é¡µé¢çš„èµ·å§‹æ—¶é—´
                    const { pageDuration } = this.getPageConfig();
                    this.currentStartTime = this.currentPage * pageDuration;

                    // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è¿œç¨‹è§†é¢‘ç¿»é¡µä¼˜åŒ–
                    const remoteOptimizationCheckbox = document.getElementById('remoteVideoOptimization');
                    const remoteOptimizationEnabled = remoteOptimizationCheckbox && remoteOptimizationCheckbox.checked;

                    // è¿œç¨‹è§†é¢‘æ ¹æ®ä¼˜åŒ–è®¾ç½®å†³å®šæ˜¯å¦é‡ç»˜ï¼Œæœ¬åœ°ä¿æŒéé‡ç»˜ä¼˜åŒ–
                    if (this.currentVideoUrl && !remoteOptimizationEnabled) {
                        // è¿œç¨‹è§†é¢‘ä¸”æœªå¯ç”¨ä¼˜åŒ–ï¼šå¼ºåˆ¶é‡ç»˜
                        this.updatePreviewDebouncedWrapper();
                    } else if (this.gridState.isInitialized) {
                        // æœ¬åœ°è§†é¢‘æˆ–è¿œç¨‹è§†é¢‘å·²å¯ç”¨ä¼˜åŒ–ï¼šåªè°ƒæ•´æ—¶é—´ç‚¹
                        this.updatePaginationUI();
                        this.updateGridTimePoints();
                        this.updateFileProgress();
                    } else {
                        // ç½‘æ ¼æœªåˆå§‹åŒ–ï¼šå®Œå…¨é‡ç»˜
                        this.updatePreviewDebouncedWrapper();
                    }
                }
            }

            previousPage() {
                // æ¸…ç†é¢„åŠ è½½çš„è§†é¢‘å…ƒç´ 
                this.cleanupPreloadedVideos();

                const { pageDuration } = this.getPageConfig();
                const newStartTime = Math.max(0, this.currentStartTime - pageDuration);
                this.setPageStartTime(newStartTime);

                // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è¿œç¨‹è§†é¢‘ç¿»é¡µä¼˜åŒ–
                const remoteOptimizationCheckbox = document.getElementById('remoteVideoOptimization');
                const remoteOptimizationEnabled = remoteOptimizationCheckbox && remoteOptimizationCheckbox.checked;

                // è¿œç¨‹è§†é¢‘æ ¹æ®ä¼˜åŒ–è®¾ç½®å†³å®šæ˜¯å¦é‡ç»˜ï¼Œæœ¬åœ°ä¿æŒéé‡ç»˜ä¼˜åŒ–
                if (this.currentVideoUrl && !remoteOptimizationEnabled) {
                    // è¿œç¨‹è§†é¢‘ä¸”æœªå¯ç”¨ä¼˜åŒ–ï¼šå¼ºåˆ¶é‡ç»˜
                    this.updatePreviewDebouncedWrapper();
                } else if (this.gridState.isInitialized) {
                    // æœ¬åœ°è§†é¢‘æˆ–è¿œç¨‹è§†é¢‘å·²å¯ç”¨ä¼˜åŒ–ï¼šåªè°ƒæ•´æ—¶é—´ç‚¹
                    this.updatePaginationUI();
                    this.updateGridTimePoints();
                    this.updateFileProgress();
                } else {
                    // ç½‘æ ¼æœªåˆå§‹åŒ–ï¼šå®Œå…¨é‡ç»˜
                    this.updatePreviewDebouncedWrapper();
                }
            }

            nextPage() {
                // æ¸…ç†é¢„åŠ è½½çš„è§†é¢‘å…ƒç´ 
                this.cleanupPreloadedVideos();

                const { pageDuration } = this.getPageConfig();
                const newStartTime = this.currentStartTime + pageDuration;
                this.setPageStartTime(newStartTime);

                // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è¿œç¨‹è§†é¢‘ç¿»é¡µä¼˜åŒ–
                const remoteOptimizationCheckbox = document.getElementById('remoteVideoOptimization');
                const remoteOptimizationEnabled = remoteOptimizationCheckbox && remoteOptimizationCheckbox.checked;

                // è¿œç¨‹è§†é¢‘æ ¹æ®ä¼˜åŒ–è®¾ç½®å†³å®šæ˜¯å¦é‡ç»˜ï¼Œæœ¬åœ°ä¿æŒéé‡ç»˜ä¼˜åŒ–
                if (this.currentVideoUrl && !remoteOptimizationEnabled) {
                    // è¿œç¨‹è§†é¢‘ä¸”æœªå¯ç”¨ä¼˜åŒ–ï¼šå¼ºåˆ¶é‡ç»˜
                    this.updatePreviewDebouncedWrapper();
                } else if (this.gridState.isInitialized) {
                    // æœ¬åœ°è§†é¢‘æˆ–è¿œç¨‹è§†é¢‘å·²å¯ç”¨ä¼˜åŒ–ï¼šåªè°ƒæ•´æ—¶é—´ç‚¹
                    this.updatePaginationUI();
                    this.updateGridTimePoints();
                    this.updateFileProgress();
                } else {
                    // ç½‘æ ¼æœªåˆå§‹åŒ–ï¼šå®Œå…¨é‡ç»˜
                    this.updatePreviewDebouncedWrapper();
                }
            }

            setPageStartTime(newStartTime) {
                // ç¡®ä¿æ—¶é—´å€¼çš„æœ‰æ•ˆæ€§
                if (typeof newStartTime !== 'number' || isNaN(newStartTime)) {
                    console.warn('setPageStartTime: æ— æ•ˆçš„æ—¶é—´å€¼', newStartTime);
                    return;
                }

                this.currentStartTime = Math.max(0, newStartTime);

                this.calculatePages();
                this.updatePaginationUI();

                // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è¿œç¨‹è§†é¢‘ç¿»é¡µä¼˜åŒ–
                const remoteOptimizationCheckbox = document.getElementById('remoteVideoOptimization');
                const remoteOptimizationEnabled = remoteOptimizationCheckbox && remoteOptimizationCheckbox.checked;

                // åœ¨çº¿è§†é¢‘æ ¹æ®ä¼˜åŒ–è®¾ç½®å†³å®šæ˜¯å¦é‡ç»˜ï¼Œæœ¬åœ°ä¿æŒéé‡ç»˜ä¼˜åŒ–
                if (this.currentVideoUrl && !remoteOptimizationEnabled) {
                    // è¿œç¨‹è§†é¢‘ä¸”æœªå¯ç”¨ä¼˜åŒ–ï¼šå¼ºåˆ¶é‡ç»˜
                    this.resetGridState();
                    this.updatePreviewDebouncedWrapper();
                } else {
                    // æœ¬åœ°è§†é¢‘æˆ–è¿œç¨‹è§†é¢‘å·²å¯ç”¨ä¼˜åŒ–ï¼šåªè°ƒæ•´æ—¶é—´ç‚¹
                    this.updateGridTimePoints();
                    this.updateFileProgress();
                }
            }

            // é¢„åŠ è½½ä¸‹ä¸€é¡µï¼ˆä»…ç”¨äºè¿œç¨‹è§†é¢‘ï¼‰
            preloadNextPage() {
                // 1. åªå¯¹è¿œç¨‹è§†é¢‘è¿›è¡Œé¢„åŠ è½½
                if (!this.currentVideoUrl) {
                    console.log('ğŸ”µ æœ¬åœ°è§†é¢‘ä¸éœ€è¦é¢„åŠ è½½');
                    return;
                }

                // 1.1 æ£€æŸ¥é¢„åŠ è½½å¼€å…³æ˜¯å¦å¼€å¯
                const preloadingEnabled = document.getElementById('enablePreloading').checked;
                if (!preloadingEnabled) {
                    console.log('ğŸ”µ è¿œç¨‹è§†é¢‘é¢„åŠ è½½å·²ç¦ç”¨');
                    return;
                }

                // 2. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡µ
                const { pageDuration } = this.getPageConfig();
                const videoDuration = this.originalVideo ? this.originalVideo.duration : 0;
                const nextPageStartTime = this.currentStartTime + pageDuration;

                if (nextPageStartTime >= videoDuration) {
                    console.log('ğŸ”µ å·²æ˜¯æœ€åä¸€é¡µï¼Œæ— éœ€é¢„åŠ è½½');
                    return;
                }

                console.log('ğŸ”„ å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€é¡µ...');

                // 3. æ¸…ç†æ—§çš„é¢„åŠ è½½æ•°æ®
                this.cleanupPreloadedVideos();

                // åˆå§‹åŒ–æ–°çš„ AbortController
                this.preloadAbortController = new AbortController();
                const signal = this.preloadAbortController.signal;

                // 4. è®¡ç®—ä¸‹ä¸€é¡µçš„æ ¼å­æ•°å’Œé…ç½®
                const { totalCells, cellDuration } = this.getPageConfig();

                // æ›´æ–°çŠ¶æ€UI
                const statusEl = document.getElementById('preloadingStatus');
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.textContent = `â³ æ­£åœ¨å‡†å¤‡ä¸‹ä¸€é¡µ... (0/0)`;
                }

                let plannedPreloadCount = 0;
                let loadedPreloadCount = 0;

                // 5. å…ˆè®¡ç®—å®é™…éœ€è¦é¢„åŠ è½½çš„æ•°é‡
                for (let i = 0; i < totalCells; i++) {
                    const startTime = nextPageStartTime + i * cellDuration;
                    if (startTime < videoDuration) {
                        plannedPreloadCount++;
                    }
                }

                if (statusEl) {
                    statusEl.textContent = `â³ æ­£åœ¨å‡†å¤‡ä¸‹ä¸€é¡µ... (0/${plannedPreloadCount})`;
                }

                // 6. åˆ›å»ºé¢„åŠ è½½videoå…ƒç´ 
                for (let i = 0; i < totalCells; i++) {
                    const startTime = nextPageStartTime + i * cellDuration;

                    // å¦‚æœè¶…å‡ºè§†é¢‘æ—¶é•¿ï¼Œåœæ­¢åˆ›å»º
                    if (startTime >= videoDuration) {
                        break;
                    }

                    const video = document.createElement('video');
                    video.src = this.currentVideoUrl;
                    video.preload = 'auto';
                    video.muted = true;

                    // è®¾ç½®èµ·å§‹æ—¶é—´ï¼ˆè®©æµè§ˆå™¨ç¼“å†²è¯¥æ—¶é—´æ®µçš„æ•°æ®ï¼‰
                    // ä½¿ç”¨ signal è‡ªåŠ¨æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                    video.addEventListener('loadedmetadata', () => {
                        video.currentTime = startTime;
                    }, { signal });

                    let isVideoLoaded = false;
                    // ç›‘å¬ç¼“å†²è¿›åº¦
                    video.addEventListener('canplay', () => {
                        // 1. é˜²æ­¢é‡å¤è®¡æ•°
                        if (isVideoLoaded) return;

                        // 2. "é”™è¯¯äº‹ä»¶" é˜²æ­¢: éªŒè¯æ˜¯å¦åˆ°è¾¾ç›®æ ‡æ—¶é—´
                        // å…è®¸å°çš„æ—¶é—´å®¹å·® (0.5s)ï¼Œå› ä¸ºè·³è½¬å¯èƒ½ä¸æ˜¯å¸§ç²¾ç¡®çš„
                        if (Math.abs(video.currentTime - startTime) > 0.5) {
                            // console.log(`Ignored canplay at ${video.currentTime} (target: ${startTime})`);
                            return;
                        }

                        isVideoLoaded = true;
                        loadedPreloadCount++;
                        if (statusEl) {
                            if (loadedPreloadCount === plannedPreloadCount) {
                                statusEl.textContent = `âœ… ä¸‹ä¸€é¡µå‡†å¤‡å°±ç»ª! (${loadedPreloadCount}/${plannedPreloadCount})`;
                                statusEl.style.color = '#00ff00';
                            } else {
                                statusEl.textContent = `ğŸš€ æ­£åœ¨ç¼“å†²... (${loadedPreloadCount}/${plannedPreloadCount})`;
                                statusEl.style.color = '#F7C137';
                            }
                        }
                    }, { signal });

                    // ç›‘å¬é¢„åŠ è½½é”™è¯¯
                    video.addEventListener('error', (e) => {
                        const errorMsg = video.error ? video.error.message || `Code ${video.error.code}` : 'Unknown error';
                        console.error(`âŒ é¢„åŠ è½½è§†é¢‘é”™è¯¯ (æ ¼å­ ${i}):`, errorMsg);

                        if (statusEl) {
                            statusEl.textContent = `âŒ é¢„åŠ è½½å‡ºé”™: ${errorMsg}`;
                            statusEl.style.color = '#ff6b6b';
                        }

                        this.showNotification(`é¢„åŠ è½½å¼‚å¸¸: è§†é¢‘æ— æ³•åŠ è½½ (${errorMsg})`, true);
                    }, { signal });

                    this.preloadedVideos.push(video);
                }

                console.log(`âœ… é¢„åŠ è½½å®Œæˆï¼å·²å·²å¼€å§‹é¢„åŠ è½½ ${this.preloadedVideos.length} ä¸ªæ ¼å­`);
            }

            // åˆ‡æ¢é¢„åŠ è½½çŠ¶æ€
            togglePreloading() {
                const enabled = document.getElementById('enablePreloading').checked;
                if (!enabled) {
                    console.log('ğŸš« é¢„åŠ è½½å·²ç¦ç”¨ï¼Œæ¸…ç†ç°æœ‰èµ„æº...');
                    this.cleanupPreloadedVideos();
                } else {
                    console.log('âœ… é¢„åŠ è½½å·²å¯ç”¨');
                    // å¦‚æœå½“å‰æ‰€æœ‰æ ¼å­éƒ½åœ¨æ’­æ”¾ï¼Œå°è¯•ç«‹å³è§¦å‘é¢„åŠ è½½
                    if (this.cellPlayingCount === this.totalCellsInCurrentPage && this.currentVideoUrl) {
                        this.preloadNextPage();
                    }
                }
            }

            // è®¡ç®—å•å…ƒæ ¼å°ºå¯¸
            calculateCellDimensions(rows, cols, videoAspectRatio) {
                const container = document.getElementById('previewContainer');
                if (!container) {
                    console.error('previewContainer å…ƒç´ æœªæ‰¾åˆ°');
                    return { width: 0, height: 0 };
                }

                const containerHeight = container.clientHeight || 600;
                const containerWidth = container.clientWidth || 800;
                const gapSize = 2;

                const totalGapHeight = (rows - 1) * gapSize;
                const totalGapWidth = (cols - 1) * gapSize;

                const availableHeight = containerHeight - totalGapHeight;
                const availableWidth = containerWidth - totalGapWidth;

                const cellHeightBasedOnHeight = availableHeight / rows;
                const cellWidthBasedOnHeight = cellHeightBasedOnHeight * videoAspectRatio;
                const totalWidthBasedOnHeight = cellWidthBasedOnHeight * cols + totalGapWidth;

                const cellWidthBasedOnWidth = availableWidth / cols;
                const cellHeightBasedOnWidth = cellWidthBasedOnWidth / videoAspectRatio;
                const totalHeightBasedOnWidth = cellHeightBasedOnWidth * rows + totalGapHeight;

                let finalCellWidth, finalCellHeight;

                if (totalWidthBasedOnHeight <= availableWidth) {
                    finalCellHeight = cellHeightBasedOnHeight;
                    finalCellWidth = cellWidthBasedOnHeight;
                } else if (totalHeightBasedOnWidth <= availableHeight) {
                    finalCellHeight = cellHeightBasedOnWidth;
                    finalCellWidth = cellWidthBasedOnWidth;
                } else {
                    const areaBasedOnHeight = cellWidthBasedOnHeight * cellHeightBasedOnHeight * rows * cols;
                    const areaBasedOnWidth = cellWidthBasedOnWidth * cellHeightBasedOnWidth * rows * cols;

                    if (areaBasedOnHeight > areaBasedOnWidth) {
                        finalCellHeight = cellHeightBasedOnHeight;
                        finalCellWidth = cellWidthBasedOnHeight;
                    } else {
                        finalCellHeight = cellHeightBasedOnWidth;
                        finalCellWidth = cellWidthBasedOnWidth;
                    }
                }

                finalCellHeight = Math.max(120, finalCellHeight);
                finalCellWidth = Math.max(120 * videoAspectRatio, finalCellWidth);

                return { width: finalCellWidth, height: finalCellHeight };
            }

            renderGrid() {
                try {
                    // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°åˆ›å»ºç½‘æ ¼
                    if (this.needToRecreateGrid()) {
                        this.createGridElements();
                    } else {
                        // åªæ›´æ–°æ—¶é—´ç‚¹ï¼Œä¸é‡æ–°åˆ›å»ºå…ƒç´ 
                        this.updateGridTimePoints();
                    }
                } catch (error) {
                    console.error('æ¸²æŸ“ç½‘æ ¼å¤±è´¥:', error);
                    this.showNotification('æ¸²æŸ“è§†é¢‘ç½‘æ ¼å¤±è´¥ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢', true);
                }
            }

            // åˆ›å»ºç½‘æ ¼å…ƒç´ ï¼ˆåªåœ¨éœ€è¦æ—¶è°ƒç”¨ï¼‰
            createGridElements() {
                try {
                    const grid = document.getElementById('videoGrid');
                    grid.innerHTML = '';

                    // æ¸…ç†æ—§ç½‘æ ¼è§†é¢‘å’Œäº‹ä»¶ï¼Œåªä¿ç•™ originalVideo (index=0)
                    this.cleanupEventListeners();
                    this.createdVideos.splice(1);

                    // æ¸…ç†é¢„åŠ è½½çš„è§†é¢‘å…ƒç´ 
                    this.cleanupPreloadedVideos();

                    const { rows, cols, cellDuration, totalCells, pageDuration } = this.getPageConfig();
                    const videoAspectRatio = this.originalVideo.videoWidth / this.originalVideo.videoHeight;
                    const { width: finalCellWidth, height: finalCellHeight } = this.calculateCellDimensions(rows, cols, videoAspectRatio);

                    grid.classList.add('video-grid-dynamic');
                    this.updateGridStyles(cols, rows, finalCellHeight, finalCellWidth);

                    // é‡ç½®çŠ¶æ€è®¡æ•°å™¨
                    this.cellLoadedCount = 0;
                    this.cellPlayingCount = 0;
                    this.totalCellsInCurrentPage = totalCells;


                    const videoDuration = this.originalVideo.duration;
                    const pageStartTime = this.currentStartTime;

                    for (let i = 0; i < totalCells; i++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-item';
                        cell.dataset.gridIndex = i; // æ·»åŠ ç½‘æ ¼ç´¢å¼•æ ‡è¯†

                        const thumbnailVideo = document.createElement('video');
                        thumbnailVideo.src = this.originalVideo.src;
                        thumbnailVideo.muted = true;
                        thumbnailVideo.loop = false;
                        thumbnailVideo.controls = false;
                        thumbnailVideo.classList.add('video-element');
                        thumbnailVideo.dataset.gridIndex = i; // æ·»åŠ ç½‘æ ¼ç´¢å¼•æ ‡è¯†

                        this.createdVideos.push(thumbnailVideo);

                        const startTime = pageStartTime + i * cellDuration;
                        const endTime = Math.min(startTime + cellDuration, Math.min(pageStartTime + pageDuration, videoDuration));

                        if (startTime >= videoDuration) {
                            cell.classList.add('hidden');
                            grid.appendChild(cell);
                            continue;
                        }

                        const loadedMetadataHandler = () => {
                            thumbnailVideo.currentTime = startTime;
                        };
                        this.addTrackedEventListener(thumbnailVideo, 'loadedmetadata', loadedMetadataHandler);

                        // çŠ¶æ€ç›‘å¬: åŠ è½½ä¸­ - è§†é¢‘æ•°æ®åŠ è½½å®Œæˆå¹¶æ˜¾ç¤ºå›¾åƒ
                        const loadedDataHandler = () => {

                            // å¢åŠ è®¡æ•°å™¨
                            this.cellLoadedCount++;

                            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªè¿›å…¥"åŠ è½½ä¸­"çŠ¶æ€çš„æ ¼å­
                            if (this.cellLoadedCount === this.totalCellsInCurrentPage) {
                                console.log(`âœ… æ‰€æœ‰æ ¼å­å·²å®ŒæˆåŠ è½½! (å…± ${this.totalCellsInCurrentPage} ä¸ªæ ¼å­)`);
                            }
                        };
                        this.addTrackedEventListener(thumbnailVideo, 'loadeddata', loadedDataHandler);

                        const seekedHandler = () => {
                            thumbnailVideo.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', e));

                            const loopHandler = () => {
                                if (thumbnailVideo.currentTime >= endTime) {
                                    thumbnailVideo.currentTime = startTime;
                                }
                            };
                            this.addTrackedEventListener(thumbnailVideo, 'timeupdate', loopHandler);
                        };
                        this.addTrackedEventListener(thumbnailVideo, 'seeked', seekedHandler);

                        // çŠ¶æ€ç›‘å¬: æ’­æ”¾ä¸­ - è§†é¢‘å¼€å§‹æ’­æ”¾
                        const playHandler = () => {

                            // å¢åŠ è®¡æ•°å™¨
                            this.cellPlayingCount++;

                            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªè¿›å…¥"æ’­æ”¾ä¸­"çŠ¶æ€çš„æ ¼å­
                            if (this.cellPlayingCount === this.totalCellsInCurrentPage) {
                                console.log(`âœ… æ‰€æœ‰æ ¼å­å·²å¼€å§‹æ’­æ”¾! (å…± ${this.totalCellsInCurrentPage} ä¸ªæ ¼å­)`);

                                // è§¦å‘é¢„åŠ è½½ä¸‹ä¸€é¡µ
                                this.preloadNextPage();
                            }
                        };
                        this.addTrackedEventListener(thumbnailVideo, 'play', playHandler);

                        const currentTimeOverlay = document.createElement('div');
                        currentTimeOverlay.className = 'current-time-overlay';
                        currentTimeOverlay.textContent = this.formatTime(startTime);

                        const timeUpdateHandler = () => {
                            currentTimeOverlay.textContent = this.formatTime(thumbnailVideo.currentTime);
                        };
                        this.addTrackedEventListener(thumbnailVideo, 'timeupdate', timeUpdateHandler);

                        const timeRangeOverlay = document.createElement('div');
                        timeRangeOverlay.className = 'time-range-overlay';
                        timeRangeOverlay.textContent = `${this.formatTime(startTime)}-${this.formatTime(endTime)}`;

                        cell.appendChild(thumbnailVideo);
                        cell.appendChild(currentTimeOverlay);
                        cell.appendChild(timeRangeOverlay);

                        // æ–°å¢åŠŸèƒ½ï¼šå•å‡»æ ¼å­å°†è¯¥æ ¼å­æ—¶é—´è®¾ä¸ºé¡µé¢èµ·å§‹æ—¶é—´
                        cell.style.cursor = 'pointer';
                        cell.onclick = (e) => {
                            e.stopPropagation();
                            const gridIndex = parseInt(cell.dataset.gridIndex);
                            if (isNaN(gridIndex)) return;
                            const { cellDuration } = this.getPageConfig();
                            const newStartTime = this.currentStartTime + gridIndex * cellDuration;
                            this.setPageStartTime(newStartTime);
                        };

                        grid.appendChild(cell);
                    }

                    // æ›´æ–°ç½‘æ ¼çŠ¶æ€
                    this.updateGridState();

                    // åˆå§‹åŒ–è§†é¢‘ç¼©æ”¾å’Œæ‹–åŠ¨äº‹ä»¶
                    this.initVideoDragAndZoom();
                } catch (error) {
                    console.error('åˆ›å»ºç½‘æ ¼å…ƒç´ å¤±è´¥:', error);
                    this.showNotification('åˆ›å»ºé¢„è§ˆæ ¼å­å¤±è´¥ï¼Œè¯·å‡å°‘è¡Œåˆ—æ•°åé‡è¯•', true);
                }
            }

            // åˆå§‹åŒ–è§†é¢‘ç¼©æ”¾å’Œæ‹–åŠ¨äº‹ä»¶
            initVideoDragAndZoom() {
                // ç§»é™¤æ—§çš„ document çº§åˆ«äº‹ä»¶ç›‘å¬å™¨
                this.removeDocumentLevelEventListeners();

                // æ·»åŠ  document çº§åˆ«äº‹ä»¶ç›‘å¬å™¨ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
                this.addDocumentLevelEventListeners();

                // ä¸ºæ¯ä¸ªè§†é¢‘é™„åŠ äº‹ä»¶
                const videos = document.querySelectorAll('.grid-item video');
                videos.forEach(video => {
                    this.attachVideoEvents(video);
                });
            }

            // ç§»é™¤ document çº§åˆ«äº‹ä»¶ç›‘å¬å™¨
            removeDocumentLevelEventListeners() {
                if (this.mouseMoveHandler) {
                    document.removeEventListener('mousemove', this.mouseMoveHandler);
                    this.mouseMoveHandler = null;
                }
                if (this.mouseUpHandler) {
                    document.removeEventListener('mouseup', this.mouseUpHandler);
                    this.mouseUpHandler = null;
                }
            }

            // æ·»åŠ  document çº§åˆ«äº‹ä»¶ç›‘å¬å™¨
            addDocumentLevelEventListeners() {
                // é¼ æ ‡ç§»åŠ¨æ‹–åŠ¨è§†é¢‘
                this.mouseMoveHandler = (e) => {
                    if (this.isDragging) {
                        // æ£€æµ‹æ˜¯å¦å‘ç”Ÿäº†å®é™…ç§»åŠ¨
                        const currentTranslateX = e.clientX - this.dragStartX;
                        const currentTranslateY = e.clientY - this.dragStartY;

                        // å¦‚æœä½ç½®æœ‰å˜åŒ–ï¼Œæ ‡è®°ä¸ºå·²ç§»åŠ¨
                        if (Math.abs(currentTranslateX - this.videoTranslateX) > 1 ||
                            Math.abs(currentTranslateY - this.videoTranslateY) > 1) {
                            this.hasMoved = true;
                            // æ ‡è®°å‘ç”Ÿè¿‡å˜æ¢å¹¶æ˜¾ç¤ºé‡ç½®æŒ‰é’®
                            this.hasTransformed = true;
                            this.showResetTransformButton();
                        }

                        this.videoTranslateX = currentTranslateX;
                        this.videoTranslateY = currentTranslateY;

                        // åŒæ­¥åº”ç”¨åˆ°æ‰€æœ‰æ ¼å­çš„è§†é¢‘
                        this.applyVideoTransformToAll();
                    }
                };
                document.addEventListener('mousemove', this.mouseMoveHandler);

                // é¼ æ ‡é‡Šæ”¾ç»“æŸæ‹–åŠ¨
                this.mouseUpHandler = (e) => {
                    if (this.isDragging) {
                        this.isDragging = false;
                        // å¦‚æœå‘ç”Ÿäº†æ‹–åŠ¨ï¼Œé˜»æ­¢è§†é¢‘çš„ç‚¹å‡»æ’­æ”¾/æš‚åœäº‹ä»¶
                        if (this.hasMoved) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }
                };
                document.addEventListener('mouseup', this.mouseUpHandler);
            }

            // ä¸ºå•ä¸ªè§†é¢‘é™„åŠ ç¼©æ”¾å’Œæ‹–åŠ¨äº‹ä»¶
            attachVideoEvents(video) {
                // é¼ æ ‡æ»šè½®ç¼©æ”¾è§†é¢‘ï¼ˆä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒè¿›è¡Œç¼©æ”¾ï¼‰
                const wheelHandler = (e) => {
                    e.preventDefault();

                    // è·å–æ ¼å­å®¹å™¨å’Œé¼ æ ‡ä½ç½®
                    const cell = video.parentElement;
                    const cellRect = cell.getBoundingClientRect();
                    const cellCenterX = cellRect.width / 2;
                    const cellCenterY = cellRect.height / 2;

                    // é¼ æ ‡ç›¸å¯¹äºæ ¼å­ä¸­å¿ƒçš„åç§»é‡
                    const mouseX = e.clientX - cellRect.left - cellCenterX;
                    const mouseY = e.clientY - cellRect.top - cellCenterY;

                    // è®°å½•ç¼©æ”¾å‰çš„çŠ¶æ€
                    const oldScale = this.videoScale;

                    // ç¼©æ”¾ç³»æ•°è®¾ä¸º0.1ï¼Œå³æ¯æ¬¡æ»šåŠ¨æ”¹å˜10%
                    const zoomFactor = 0.1;

                    if (e.deltaY < 0) {
                        // å‘ä¸Šæ»šåŠ¨ï¼Œæ”¾å¤§
                        this.videoScale += zoomFactor;
                    } else {
                        // å‘ä¸‹æ»šåŠ¨ï¼Œç¼©å°
                        this.videoScale -= zoomFactor;
                    }

                    // é™åˆ¶æœ€å°ç¼©æ”¾èŒƒå›´
                    if (this.videoScale < 0.1) {
                        this.videoScale = 0.1;
                    }

                    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹çš„å˜åŒ–
                    const scaleChange = this.videoScale / oldScale;

                    // è°ƒæ•´å¹³ç§»é‡ï¼Œä½¿å¾—é¼ æ ‡æŒ‡å‘çš„å†…å®¹ç‚¹ä¿æŒä¸å˜
                    this.videoTranslateX = this.videoTranslateX + (mouseX - this.videoTranslateX) * (1 - scaleChange);
                    this.videoTranslateY = this.videoTranslateY + (mouseY - this.videoTranslateY) * (1 - scaleChange);

                    // æ ‡è®°å‘ç”Ÿè¿‡å˜æ¢å¹¶æ˜¾ç¤ºé‡ç½®æŒ‰é’®
                    this.hasTransformed = true;
                    this.showResetTransformButton();

                    // åŒæ­¥åº”ç”¨åˆ°æ‰€æœ‰æ ¼å­çš„è§†é¢‘
                    this.applyVideoTransformToAll();
                };
                this.addTrackedEventListener(video, 'wheel', wheelHandler);

                // é¼ æ ‡æŒ‰ä¸‹å¼€å§‹æ‹–åŠ¨
                const mousedownHandler = (e) => {
                    this.isDragging = true;
                    this.hasMoved = false;
                    this.dragStartX = e.clientX - this.videoTranslateX;
                    this.dragStartY = e.clientY - this.videoTranslateY;
                    e.preventDefault(); // é˜»æ­¢è§†é¢‘é»˜è®¤è¡Œä¸º
                };
                this.addTrackedEventListener(video, 'mousedown', mousedownHandler);

                // é˜»æ­¢è§†é¢‘çš„clickäº‹ä»¶ï¼ˆå¦‚æœå‘ç”Ÿäº†æ‹–åŠ¨ï¼‰
                const clickHandler = (e) => {
                    if (this.hasMoved) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                };
                this.addTrackedEventListener(video, 'click', clickHandler);
            }

            // åŒæ­¥åº”ç”¨å˜æ¢åˆ°æ‰€æœ‰æ ¼å­çš„è§†é¢‘
            applyVideoTransformToAll() {
                const videos = document.querySelectorAll('.grid-item video');
                videos.forEach(video => {
                    video.style.transform = `translate(${this.videoTranslateX}px, ${this.videoTranslateY}px) scale(${this.videoScale})`;
                });
            }

            // æ˜¾ç¤ºé‡ç½®ç¼©æ”¾å’Œä½ç½®æŒ‰é’®
            showResetTransformButton() {
                const resetSection = document.getElementById('resetTransformSection');
                if (resetSection) {
                    resetSection.classList.remove('is-hidden');
                }
            }

            // é‡ç½®è§†é¢‘ç¼©æ”¾å’Œä½ç½®
            resetVideoTransform() {
                // é‡ç½®ç¼©æ”¾å’Œæ‹–åŠ¨çŠ¶æ€
                this.videoScale = 1;
                this.videoTranslateX = 0;
                this.videoTranslateY = 0;
                this.hasTransformed = false;
                this.hasMoved = false;

                // åº”ç”¨é‡ç½®åçš„å˜æ¢
                this.applyVideoTransformToAll();

                // éšè—é‡ç½®æŒ‰é’®
                const resetSection = document.getElementById('resetTransformSection');
                if (resetSection) {
                    resetSection.classList.add('is-hidden');
                }

                // æ˜¾ç¤ºæç¤º
                this.showNotification('ç¼©æ”¾å’Œä½ç½®å·²é‡ç½®', false);
            }

            // æ›´æ–°ç½‘æ ¼æ—¶é—´ç‚¹ï¼ˆåªåœ¨é¡µé¢åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
            updateGridTimePoints() {
                try {
                    // è¾¹ç•Œæ£€æŸ¥ï¼šç¡®ä¿åŸå§‹è§†é¢‘å­˜åœ¨ä¸”å·²åŠ è½½
                    if (!this.originalVideo || !this.originalVideo.duration || this.originalVideo.duration <= 0) {
                        console.warn('æ— æ³•æ›´æ–°æ—¶é—´ç‚¹ï¼šåŸå§‹è§†é¢‘æœªå‡†å¤‡å¥½');
                        return;
                    }

                    const { cellDuration, totalCells, pageDuration } = this.getPageConfig();
                    const videoDuration = this.originalVideo.duration;
                    const pageStartTime = this.currentStartTime;

                    // è¾¹ç•Œæ£€æŸ¥ï¼šç¡®ä¿æ—¶é—´å‚æ•°æœ‰æ•ˆ
                    if (cellDuration <= 0 || totalCells <= 0 || pageDuration <= 0) {
                        console.warn('æ— æ•ˆçš„ç½‘æ ¼é…ç½®å‚æ•°');
                        return;
                    }

                    // éå†ç°æœ‰çš„è§†é¢‘å…ƒç´ ï¼Œåªæ›´æ–°æ—¶é—´ç›¸å…³å±æ€§
                    this.createdVideos.forEach((video, index) => {
                        if (index === 0) return; // è·³è¿‡originalVideo

                        const gridIndex = parseInt(video.dataset.gridIndex);
                        if (isNaN(gridIndex)) return; // è·³è¿‡æ²¡æœ‰ç½‘æ ¼ç´¢å¼•çš„è§†é¢‘

                        // è®¡ç®—æ ¼å­åœ¨æ•´ä¸ªè§†é¢‘ä¸­çš„å®é™…å¼€å§‹æ—¶é—´
                        const startTime = pageStartTime + gridIndex * cellDuration;
                        const endTime = Math.min(startTime + cellDuration, Math.min(pageStartTime + pageDuration, videoDuration));

                        // è·å–å¯¹åº”çš„å•å…ƒæ ¼å’Œè¦†ç›–å±‚å…ƒç´ 
                        const cell = video.parentElement;
                        if (!cell) {
                            console.warn(`æ‰¾ä¸åˆ°ç½‘æ ¼ç´¢å¼• ${gridIndex} çš„å•å…ƒæ ¼`);
                            return;
                        }

                        const currentTimeOverlay = cell.querySelector('.current-time-overlay');
                        const timeRangeOverlay = cell.querySelector('.time-range-overlay');

                        // æ ¹æ®å½“å‰é¡µé¢å’Œæ ¼å­ç´¢å¼•ï¼Œåˆ¤æ–­æ˜¯å¦åº”è¯¥æ˜¾ç¤ºè¯¥æ ¼å­
                        const shouldShowCell = startTime < videoDuration;

                        if (shouldShowCell) {
                            // æ˜¾ç¤ºæœ‰æ•ˆçš„æ ¼å­
                            cell.classList.remove('hidden');

                            try {
                                // ç§»é™¤æ—§çš„æ—¶é—´æ›´æ–°äº‹ä»¶ç›‘å¬å™¨
                                this.removeVideoTimeUpdateListeners(video);

                                // æ›´æ–°æ—¶é—´æ˜¾ç¤ºè¦†ç›–å±‚ - æ˜¾ç¤ºåœ¨æ•´ä¸ªè§†é¢‘ä¸­çš„å®é™…æ—¶é—´
                                if (currentTimeOverlay) {
                                    currentTimeOverlay.textContent = this.formatTime(startTime);
                                }

                                if (timeRangeOverlay) {
                                    timeRangeOverlay.textContent = `${this.formatTime(startTime)}-${this.formatTime(endTime)}`;
                                }

                                // é‡æ–°ç»‘å®šå¾ªç¯æ’­æ”¾é€»è¾‘å’Œæ—¶é—´æ›´æ–°
                                const seekedHandler = () => {
                                    // ç¡®ä¿æ—¶é—´æ˜¾ç¤ºæ­£ç¡®
                                    if (currentTimeOverlay) {
                                        currentTimeOverlay.textContent = this.formatTime(video.currentTime);
                                    }

                                    video.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', e));

                                    const loopHandler = () => {
                                        if (video.currentTime >= endTime) {
                                            video.currentTime = startTime;
                                        }
                                    };
                                    this.addTrackedEventListener(video, 'timeupdate', loopHandler);

                                    // æ·»åŠ æ—¶é—´æ›´æ–°å¤„ç†å™¨
                                    if (currentTimeOverlay) {
                                        const timeUpdateHandler = () => {
                                            currentTimeOverlay.textContent = this.formatTime(video.currentTime);
                                        };
                                        this.addTrackedEventListener(video, 'timeupdate', timeUpdateHandler);
                                    }
                                };

                                // è®¾ç½®è§†é¢‘æ—¶é—´ç‚¹å¹¶ç­‰å¾…seekedäº‹ä»¶
                                if (video.readyState >= 2) { // HAVE_CURRENT_DATA
                                    // å¦‚æœè§†é¢‘å·²ç»å‡†å¤‡å¥½ï¼Œç›´æ¥è®¾ç½®æ—¶é—´ç‚¹
                                    video.currentTime = startTime;

                                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿seekå®Œæˆï¼Œç„¶åæ’­æ”¾
                                    setTimeout(() => {
                                        if (currentTimeOverlay) {
                                            currentTimeOverlay.textContent = this.formatTime(video.currentTime);
                                        }
                                        video.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', e));

                                        const loopHandler = () => {
                                            if (video.currentTime >= endTime) {
                                                video.currentTime = startTime;
                                            }
                                        };
                                        this.addTrackedEventListener(video, 'timeupdate', loopHandler);

                                        // æ·»åŠ æ—¶é—´æ›´æ–°å¤„ç†å™¨
                                        if (currentTimeOverlay) {
                                            const timeUpdateHandler = () => {
                                                currentTimeOverlay.textContent = this.formatTime(video.currentTime);
                                            };
                                            this.addTrackedEventListener(video, 'timeupdate', timeUpdateHandler);
                                        }
                                    }, 50);
                                } else {
                                    // å¦‚æœè§†é¢‘è¿˜æ²¡å‡†å¤‡å¥½ï¼Œç­‰å¾…seekedäº‹ä»¶
                                    this.addTrackedEventListener(video, 'seeked', seekedHandler);
                                    video.currentTime = startTime;
                                }
                            } catch (e) {
                                console.error(`æ›´æ–°ç½‘æ ¼ç´¢å¼• ${gridIndex} çš„æ—¶é—´ç‚¹å¤±è´¥:`, e);
                            }
                        } else {
                            // éšè—è¶…å‡ºè§†é¢‘é•¿åº¦çš„æ ¼å­
                            cell.classList.add('hidden');
                            try {
                                video.pause();
                            } catch (e) {
                                console.warn('æš‚åœè§†é¢‘å¤±è´¥:', e);
                            }
                            return;
                        }

                    });
                } catch (error) {
                    console.error('æ›´æ–°ç½‘æ ¼æ—¶é—´ç‚¹å¤±è´¥:', error);
                    this.showNotification('æ›´æ–°è§†é¢‘é¢„è§ˆç‚¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', true);
                }
            }

            // ç§»é™¤ç‰¹å®šè§†é¢‘çš„æ—¶é—´æ›´æ–°äº‹ä»¶ç›‘å¬å™¨
            removeVideoTimeUpdateListeners(video) {
                if (!video) {
                    console.warn('å°è¯•ç§»é™¤ç©ºè§†é¢‘çš„äº‹ä»¶ç›‘å¬å™¨');
                    return;
                }

                try {
                    // æ‰¾åˆ°å¹¶ç§»é™¤ä¸è¯¥è§†é¢‘ç›¸å…³çš„æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼ˆä¸ä»…ä»…æ˜¯timeupdateï¼‰
                    const listenersToRemove = this.eventListeners.filter(({ element }) => element === video);

                    listenersToRemove.forEach(({ element, event, handler }) => {
                        try {
                            element.removeEventListener(event, handler);
                        } catch (e) {
                            console.warn(`ç§»é™¤äº‹ä»¶ç›‘å¬å™¨å¤±è´¥ (${event}):`, e);
                        }
                    });

                    // ä»æ•°ç»„ä¸­ç§»é™¤æ‰€æœ‰ç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨
                    this.eventListeners = this.eventListeners.filter(({ element }) => element !== video);

                } catch (e) {
                    console.error('ç§»é™¤è§†é¢‘äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', e);
                }
            }

            formatTime(seconds) {
                // æ·»åŠ ç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤æ ¼å¼åŒ–ç›¸åŒçš„æ—¶é—´å€¼
                const cacheKey = Math.round(seconds * 100) / 100; // ä¿ç•™2ä½å°æ•°çš„ç²¾åº¦
                if (this._timeFormatCache && this._timeFormatCache.has(cacheKey)) {
                    return this._timeFormatCache.get(cacheKey);
                }

                // åˆå§‹åŒ–ç¼“å­˜
                if (!this._timeFormatCache) {
                    this._timeFormatCache = new Map();
                    // é™åˆ¶ç¼“å­˜å¤§å°ï¼Œé¿å…å†…å­˜æ³„æ¼
                    this._timeFormatCache.maxSize = 100;
                }

                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                let formattedTime;

                if (hours > 0) {
                    formattedTime = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    formattedTime = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }

                // ç¼“å­˜ç»“æœ
                if (this._timeFormatCache.size >= this._timeFormatCache.maxSize) {
                    // æ¸…ç†æœ€æ—§çš„ç¼“å­˜é¡¹
                    const firstKey = this._timeFormatCache.keys().next().value;
                    this._timeFormatCache.delete(firstKey);
                }
                this._timeFormatCache.set(cacheKey, formattedTime);

                return formattedTime;
            }

            showLoading(show) {
                if (show) {
                    document.getElementById('loading').classList.remove('hidden');
                    document.getElementById('loading').classList.add('visible');
                } else {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('loading').classList.add('visible');
                }
            }

            showError(message) {
                const container = document.getElementById('previewContainer');
                let errorDiv = container.querySelector('.error');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    container.appendChild(errorDiv);
                }
                errorDiv.textContent = message;
            }

            clearError() {
                const container = document.getElementById('previewContainer');
                const errorDiv = container.querySelector('.error');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }

            updateGridDisplay() {
                const rows = parseInt(document.getElementById('gridSize').value);
                const cols = parseInt(document.getElementById('gridSize2').value);
                const total = rows * cols;
                document.getElementById('gridDisplay').textContent = `${rows}Ã—${cols} = ${total}ä¸ª`;
            }

            // è·å–è§†é¢‘æ—¶é•¿
            async getVideoDuration(file) {
                return new Promise((resolve, reject) => {
                    const videoURL = URL.createObjectURL(file);
                    const video = document.createElement('video');

                    video.onloadedmetadata = () => {
                        const duration = this.formatTime(video.duration);
                        URL.revokeObjectURL(videoURL);
                        resolve(duration);
                    };

                    video.onerror = () => {
                        URL.revokeObjectURL(videoURL);
                        reject(new Error('æ— æ³•åŠ è½½è§†é¢‘æ–‡ä»¶'));
                    };

                    video.src = videoURL;
                });
            }

            // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
            updateFileList() {
                const fileListSection = document.getElementById('fileListSection');
                const fileList = document.getElementById('fileList');

                if (this.videoFiles.length === 0) {
                    fileListSection.classList.add('is-hidden');
                    return;
                }

                fileListSection.classList.remove('is-hidden');
                fileList.innerHTML = '';

                this.videoFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item' + (index === this.currentVideoIndex ? ' active' : '');

                    const fileNameDiv = document.createElement('div');
                    fileNameDiv.className = 'file-name';
                    fileNameDiv.textContent = file.name;

                    const fileInfoDiv = document.createElement('div');
                    fileInfoDiv.className = 'file-info';
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
                    fileInfoDiv.innerHTML = `<span class="duration-info">åŠ è½½ä¸­...</span> | ${sizeMB} MB`;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'file-remove';
                    removeBtn.textContent = 'Ã—';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.removeFile(index);
                    };

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'content-flex';
                    contentDiv.appendChild(fileNameDiv);
                    contentDiv.appendChild(fileInfoDiv);

                    // åˆ›å»ºä¸ŠåŠéƒ¨åˆ†å®¹å™¨
                    const topRow = document.createElement('div');
                    topRow.className = 'file-item-top';
                    topRow.appendChild(contentDiv);
                    topRow.appendChild(removeBtn);

                    fileItem.appendChild(topRow);

                    fileItem.onclick = () => this.switchToFile(index);

                    fileList.appendChild(fileItem);

                    // å¼‚æ­¥è·å–è§†é¢‘æ—¶é•¿
                    this.getVideoDuration(file).then(duration => {
                        const durationSpan = fileInfoDiv.querySelector('.duration-info');
                        if (durationSpan) {
                            durationSpan.textContent = duration;
                        }
                    }).catch(error => {
                        const durationSpan = fileInfoDiv.querySelector('.duration-info');
                        if (durationSpan) {
                            durationSpan.textContent = 'æœªçŸ¥';
                        }
                        console.warn(`è·å–è§†é¢‘æ—¶é•¿å¤±è´¥: ${file.name}`, error);
                    });
                });
            }

            // åˆ‡æ¢åˆ°æŒ‡å®šæ–‡ä»¶
            // åœ¨ switchToFile æ—¶ä¹Ÿé‡ç½® URL
            async switchToFile(index) {
                this.currentVideoUrl = null;
                if (index < 0 || index >= this.videoFiles.length) return;

                // è®¾ç½®å½“å‰æ–‡ä»¶ç´¢å¼•å’Œè§†é¢‘å¯¹è±¡
                this.currentVideoIndex = index;
                this.currentVideo = this.videoFiles[index];

                // æ›´æ–°æ–‡ä»¶åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
                this.updateFileList();

                // é‡ç½®åˆ†é¡µçŠ¶æ€
                this.currentPage = 0;
                this.totalPages = 0;
                this.currentStartTime = 0; // é‡ç½®èµ·å§‹æ—¶é—´

                // é‡ç½®ç½‘æ ¼çŠ¶æ€ï¼Œå¼ºåˆ¶é‡æ–°åˆ›å»ºç½‘æ ¼
                this.resetGridState();

                // ä½¿ç”¨é˜²æŠ–ç‰ˆæœ¬åŠ è½½æ–°è§†é¢‘
                this.loadVideoDebouncedWrapper();
            }

            // ç§»é™¤æ–‡ä»¶
            removeFile(index) {
                if (index < 0 || index >= this.videoFiles.length) return;

                this.videoFiles.splice(index, 1);

                // è°ƒæ•´å½“å‰æ–‡ä»¶ç´¢å¼•
                if (this.currentVideoIndex >= this.videoFiles.length) {
                    this.currentVideoIndex = this.videoFiles.length - 1;
                }

                // æ›´æ–°å½“å‰è§†é¢‘
                if (this.videoFiles.length > 0) {
                    this.currentVideo = this.videoFiles[this.currentVideoIndex];
                } else {
                    this.currentVideo = null;
                    this.originalVideo = null;
                    this.clearVideoDisplay();
                }

                this.updateFileList();

                // å¦‚æœè¿˜æœ‰æ–‡ä»¶ï¼ŒåŠ è½½å½“å‰æ–‡ä»¶
                if (this.videoFiles.length > 0) {
                    this.loadVideoDebouncedWrapper();
                }
            }

            // æ¸…ç©ºè§†é¢‘æ˜¾ç¤º
            clearVideoDisplay() {
                document.getElementById('videoGrid').innerHTML = '';
                document.getElementById('videoInfo').classList.add('hidden');
                document.getElementById('videoInfo').classList.remove('visible');
                document.getElementById('pagination').classList.add('hidden');
                document.getElementById('pagination').classList.remove('visible');
            }

            // æ›´æ–°æ–‡ä»¶åˆ—è¡¨ä¸­çš„è¿›åº¦æ¡
            updateFileProgress() {
                if (!this.originalVideo || !this.originalVideo.duration) return;

                const { pageDuration } = this.getPageConfig();
                const videoDuration = this.originalVideo.duration;
                if (!videoDuration) return;

                const startTime = this.currentStartTime;
                const endTime = Math.min(startTime + pageDuration, videoDuration);

                const startPercent = (startTime / videoDuration) * 100;
                const widthPercent = ((endTime - startTime) / videoDuration) * 100;

                // ç»Ÿä¸€æ›´æ–°è¿›åº¦æ¡é€»è¾‘
                const progressWrapper = document.getElementById('unified-progress');

                if (progressWrapper) {
                    const progressFill = progressWrapper.querySelector('.file-progress-fill');
                    const progressIndicator = progressWrapper.querySelector('.progress-indicator-line');

                    if (progressFill) {
                        // ç›´æ¥ä½¿ç”¨å†…è”æ ·å¼è®¾ç½®ä½ç½®å’Œå®½åº¦
                        progressFill.style.left = `${startPercent}%`;
                        progressFill.style.width = `${widthPercent}%`;
                    }

                    progressWrapper.title = `å½“å‰æ˜¾ç¤º: ${this.formatTime(startTime)} - ${this.formatTime(endTime)} (æ€»é•¿: ${this.formatTime(videoDuration)})`;

                    if (progressIndicator) {
                        const firstCellProgressPercent = this.getFirstCellProgress();
                        const indicatorPosition = startPercent + (firstCellProgressPercent * widthPercent / 100);
                        // ç›´æ¥ä½¿ç”¨å†…è”æ ·å¼è®¾ç½®ä½ç½®
                        progressIndicator.style.left = `${indicatorPosition}%`;
                    }
                }
            }

            // åŠ¨æ€æ›´æ–°ç½‘æ ¼æ ·å¼
            updateGridStyles(cols, rows, rowHeight, cellWidth = null) {
                // æŸ¥æ‰¾æˆ–åˆ›å»ºåŠ¨æ€æ ·å¼è¡¨
                let dynamicStyle = document.getElementById('dynamic-grid-styles');
                if (!dynamicStyle) {
                    dynamicStyle = document.createElement('style');
                    dynamicStyle.id = 'dynamic-grid-styles';
                    document.head.appendChild(dynamicStyle);
                }

                // æ ¹æ®æ˜¯å¦æä¾›å®½åº¦å†³å®šä½¿ç”¨å“ªç§å¸ƒå±€
                if (cellWidth) {
                    // ä½¿ç”¨å›ºå®šå®½åº¦çš„æ ¼å­
                    dynamicStyle.textContent = `
                        .video-grid-dynamic {
                            --grid-columns: ${cols};
                            --grid-rows: ${rows};
                            --row-height: ${rowHeight}px;
                            --cell-width: ${cellWidth}px;
                            grid-template-columns: repeat(var(--grid-columns), var(--cell-width));
                            grid-template-rows: repeat(var(--grid-rows), var(--row-height));
                            justify-content: center;
                            align-content: center;
                            width: fit-content;
                            margin: 0 auto;
                        }
                    `;
                } else {
                    // ä½¿ç”¨å¼¹æ€§å®½åº¦çš„æ ¼å­ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
                    dynamicStyle.textContent = `
                        .video-grid-dynamic {
                            --grid-columns: ${cols};
                            --grid-rows: ${rows};
                            --row-height: ${rowHeight}px;
                            grid-template-columns: repeat(var(--grid-columns), 1fr);
                            grid-template-rows: repeat(var(--grid-rows), var(--row-height));
                        }
                    `;
                }
            }

            // å¼ºåˆ¶æ¸…ç†èµ„æº
            forceCleanup() {
                // åœæ­¢è¿›åº¦æ ‡è¯†çº¿æ›´æ–°
                this.stopProgressIndicator();

                // åœæ­¢è§†é¢‘æ’­æ”¾çŠ¶æ€æ£€æµ‹å™¨
                this.stopVideoPlayMonitor();

                // æš‚åœæ‰€æœ‰è§†é¢‘
                this.createdVideos.forEach(video => {
                    try {
                        video.pause();
                    } catch (e) {
                        console.error('æš‚åœè§†é¢‘å¤±è´¥:', e);
                    }
                });

                // æ¸…ç†ç½‘æ ¼ä¸­çš„è§†é¢‘å…ƒç´ 
                const grid = document.getElementById('videoGrid');
                if (grid) {
                    grid.innerHTML = '';
                }

                // æ¸…ç†æ‰€æœ‰èµ„æº
                this.cleanupVideos();
                this.cleanupPreloadedVideos();  // æ¸…ç†é¢„åŠ è½½è§†é¢‘
                this.cleanupURLs();
                this.cleanupEventListeners();

                // é‡ç½®ç½‘æ ¼çŠ¶æ€
                this.resetGridState();

                // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
                if (window.gc) {
                    window.gc();
                }

                // æ˜¾ç¤ºæ¸…ç†å®Œæˆæç¤º
                this.showNotification('å†…å­˜æ¸…ç†å®Œæˆ', false);
            }

            // å¯åŠ¨å‚ç›´è¿›åº¦æ ‡è¯†çº¿æ›´æ–°
            startProgressIndicator() {
                // æ¯100msæ›´æ–°ä¸€æ¬¡å‚ç›´çº¿ä½ç½®
                this.progressIndicatorInterval = setInterval(() => {
                    this.updateFileProgress();
                }, 100);
            }

            // åœæ­¢å‚ç›´è¿›åº¦æ ‡è¯†çº¿æ›´æ–°
            stopProgressIndicator() {
                if (this.progressIndicatorInterval) {
                    clearInterval(this.progressIndicatorInterval);
                    this.progressIndicatorInterval = null;
                }
            }

            // è®¡ç®—ç¬¬ä¸€ä¸ªæ ¼å­çš„æ’­æ”¾è¿›åº¦ç™¾åˆ†æ¯”
            getFirstCellProgress() {
                if (!this.originalVideo || this.createdVideos.length <= 1) {
                    return 0;
                }

                const cellDuration = parseInt(document.getElementById('duration').value);
                // æ³¨æ„ï¼šcreatedVideos[0]æ˜¯originalVideoï¼ŒcreatedVideos[1]æ‰æ˜¯ç¬¬ä¸€ä¸ªæ ¼å­çš„è§†é¢‘
                const firstGridVideo = this.createdVideos[1];

                if (!firstGridVideo || isNaN(firstGridVideo.currentTime)) {
                    return 0;
                }

                const progressInCell = firstGridVideo.currentTime - this.currentStartTime;
                const clampedProgress = Math.max(0, Math.min(progressInCell, cellDuration));

                return (clampedProgress / cellDuration) * 100;
            }

            // æ˜¾ç¤ºé€šçŸ¥ (å¸¦é˜²æŠ–å’Œåˆå¹¶åŠŸèƒ½)
            showNotification(message, isError = false) {
                // å¦‚æœä¸æ˜¯é”™è¯¯é€šçŸ¥ï¼Œç›´æ¥æ˜¾ç¤º
                if (!isError) {
                    this._renderNotification(message, false);
                    return;
                }

                // é”™è¯¯é€šçŸ¥é˜²æŠ–é€»è¾‘
                const now = Date.now();

                // å¦‚æœæ˜¯ç›¸åŒçš„é”™è¯¯æ¶ˆæ¯ï¼Œä¸”è·ç¦»ä¸Šæ¬¡æ˜¾ç¤ºä¸è¶³2ç§’ï¼Œåˆ™å¿½ç•¥
                if (message === this.lastErrorMessage && now - this.lastErrorNotification < 2000) {
                    return;
                }

                // å¦‚æœè·ç¦»ä¸Šæ¬¡é”™è¯¯é€šçŸ¥ä¸è¶³1ç§’ï¼Œåˆå¹¶æ˜¾ç¤º
                if (now - this.lastErrorNotification < 1000) {
                    this.errorNotificationCount++;
                    // å¦‚æœé”™è¯¯æ•°é‡è¿‡å¤šï¼Œæ˜¾ç¤ºæ³›åŒ–æ¶ˆæ¯
                    if (this.errorNotificationCount > 3) {
                        // ç§»é™¤ä¸Šä¸€ä¸ªé€šçŸ¥ï¼ˆå¦‚æœè¿˜åœ¨ï¼‰- è¿™é‡Œç®€å•å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤ºæ–°é€šçŸ¥
                        this._renderNotification(`âš ï¸ æ£€æµ‹åˆ°å¤šä¸ªé”™è¯¯ (${this.errorNotificationCount}ä¸ª)ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°`, true);
                        this.lastErrorNotification = now;
                        return; // ä¸å†æ˜¾ç¤ºå…·ä½“æ¶ˆæ¯
                    }
                } else {
                    // é‡ç½®è®¡æ•°
                    this.errorNotificationCount = 1;
                }

                this.lastErrorMessage = message;
                this.lastErrorNotification = now;
                this._renderNotification(message, true);
            }

            // å†…éƒ¨æ¸²æŸ“é€šçŸ¥æ–¹æ³•
            _renderNotification(message, isError) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${isError ? '#f44336' : '#4CAF50'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 4px;
                    z-index: 1000;
                    font-size: 14px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    animation: slideIn 0.3s ease-out;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 3000);
            }

            async loadRemoteVideo(url) {
                if (!url || typeof url !== 'string') {
                    this.showError('æ— æ•ˆçš„è§†é¢‘ URL');
                    return;
                }

                // é‡ç½®æœ¬åœ°è§†é¢‘çŠ¶æ€
                this.currentVideo = null;
                this.currentVideoUrl = url;

                // é‡ç½®åˆ†é¡µå’Œç½‘æ ¼çŠ¶æ€
                this.currentPage = 0;
                this.totalPages = 0;
                this.currentStartTime = 0;
                this.resetGridState();

                this.isLoading = true;
                this.showLoading(true);
                this.clearError();

                try {
                    const video = document.createElement('video');

                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            video.onerror = null; // æˆåŠŸåŠ è½½å…ƒæ•°æ®åï¼Œç§»é™¤é”™è¯¯å¤„ç†å™¨
                            // æ¸…ç†æ—§èµ„æº
                            this.cleanupVideos();
                            this.cleanupURLs();

                            this.originalVideo = video;
                            this.createdVideos.push(video);
                            resolve();
                        };
                        video.onerror = () => {
                            reject(new Error('æ— æ³•åŠ è½½è§†é¢‘ï¼Œè¯·æ£€æŸ¥ URL å’Œ CORS'));
                        };
                        video.src = url;
                    });

                    this.updateVideoInfo();
                    this.updatePreview();

                    // å¯åŠ¨è¿›åº¦æŒ‡ç¤ºå™¨
                    this.startProgressIndicator();

                    // ç«‹å³æ›´æ–°ä¸€æ¬¡è¿›åº¦æ¡
                    this.updateFileProgress();

                } catch (error) {
                    console.error('è¿œç¨‹è§†é¢‘åŠ è½½å¤±è´¥:', error);
                    this.showError(`è¿œç¨‹è§†é¢‘åŠ è½½å¤±è´¥: ${error.message}`);
                    this.showNotification(`è¿œç¨‹è§†é¢‘åŠ è½½å¤±è´¥: ${error.message}`, true);
                } finally {
                    this.isLoading = false;
                    this.showLoading(false);
                }
            }

            // åˆå§‹åŒ–å…¨å±€é”™è¯¯å¤„ç†
            initGlobalErrorHandling() {
                // æ•è·æœªå¤„ç†çš„Promiseæ‹’ç»
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('Unhandled Rejection:', event.reason);
                    this.showNotification('å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°', true);
                });

                // æ•è·å¸¸è§„è¿è¡Œæ—¶é”™è¯¯
                window.addEventListener('error', (event) => {
                    console.error('Runtime Error:', event.error);
                    // è¿‡æ»¤æ‰æ— å…³çš„é”™è¯¯
                    if (event.filename && event.filename.includes('video_thumbnail_preview.html')) {
                        this.showNotification('ç³»ç»Ÿè¿è¡Œå¼‚å¸¸ï¼Œè¯·åˆ·æ–°é‡è¯•', true);
                    }
                });
            }

            // ç§»é™¤å‰ªè´´æ¿ç›‘å¬åŠŸèƒ½ï¼Œé¿å…ç”¨æˆ·å›°æƒ‘
            // ç”¨æˆ·éœ€è¦æ‰‹åŠ¨ç²˜è´´URLåˆ°è¾“å…¥æ¡†ï¼Œç„¶åç‚¹å‡»ç¡®è®¤æŒ‰é’®åŠ è½½

            // åˆ›å»ºæˆ–æ›´æ–°ç»Ÿä¸€çš„è¿›åº¦æ¡
            createOrUpdateProgressBar() {
                const container = document.getElementById('unifiedProgressBarContainer');
                if (!container) return;

                // æ¸…ç©ºæ—§çš„è¿›åº¦æ¡
                container.innerHTML = '';

                const progressWrapper = document.createElement('div');
                progressWrapper.className = 'file-progress-wrapper';
                progressWrapper.id = 'unified-progress';

                const progressFill = document.createElement('div');
                progressFill.className = 'file-progress-fill';
                progressFill.style.left = '0%';
                progressFill.style.width = '0%';

                const progressIndicator = document.createElement('div');
                progressIndicator.className = 'progress-indicator-line';
                progressIndicator.style.left = '0%';

                progressWrapper.appendChild(progressFill);
                progressWrapper.appendChild(progressIndicator);
                container.appendChild(progressWrapper);
            }
        }

        // å®ä¾‹åŒ–åº”ç”¨
        const app = new VideoThumbnailPreview();

        function selectVideo() {
            app.selectVideo();
        }

        function toggleAutoCalculateCols() {
            const checkbox = document.getElementById('autoCalculateCols');
            const colsInput = document.getElementById('gridSize2');
            const allButtons = document.querySelectorAll('.number-btn');
            const rowButtons = document.querySelectorAll('.grid-control-row:first-child .number-btn:not(.both-btn)');

            if (checkbox.checked) {
                // ç¦ç”¨åˆ—æ•°è¾“å…¥æ¡†
                colsInput.disabled = true;
                colsInput.style.opacity = '0.5';

                // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.3';
                    btn.style.cursor = 'not-allowed';
                });

                // å•ç‹¬å¯ç”¨è¡Œæ•°çš„ â–²ã€â–¼ æŒ‰é’®
                rowButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });

                calculateAndSetCols();
            } else {
                // å¯ç”¨åˆ—æ•°è¾“å…¥æ¡†
                colsInput.disabled = false;
                colsInput.style.opacity = '1';

                // å¯ç”¨æ‰€æœ‰æŒ‰é’®
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                });
            }
            updateGrid();
        }

        function calculateAndSetCols() {
            const checkbox = document.getElementById('autoCalculateCols');
            if (!checkbox.checked || !app.originalVideo) return;

            const rows = parseInt(document.getElementById('gridSize').value);
            const videoWidth = app.originalVideo.videoWidth;
            const videoHeight = app.originalVideo.videoHeight;
            const container = document.getElementById('previewContainer');

            if (!videoWidth || !videoHeight || !container) return;

            // è·å–å®¹å™¨å°ºå¯¸
            const containerWidth = container.clientWidth || 800;
            const containerHeight = container.clientHeight || 600;

            // è®¡ç®—è§†é¢‘å®½é«˜æ¯”
            const videoAspectRatio = videoWidth / videoHeight;

            // è®¡ç®—èƒ½å¤Ÿæœ€å¤§åŒ–æ˜¾ç¤ºé¢ç§¯çš„åˆ—æ•°
            const optimalCols = calculateOptimalCols(rows, videoAspectRatio, containerWidth, containerHeight);

            // è®¾ç½®åˆ—æ•°
            const colsInput = document.getElementById('gridSize2');
            colsInput.value = optimalCols;

            console.log(`è‡ªåŠ¨è®¡ç®—åˆ—æ•°: è¡Œæ•°=${rows}, è§†é¢‘å®½é«˜æ¯”=${videoAspectRatio.toFixed(2)}, æœ€ä¼˜åˆ—æ•°=${optimalCols}`);
        }

        function calculateOptimalCols(rows, videoAspectRatio, containerWidth, containerHeight) {
            // è®¡ç®—å®¹å™¨å®½é«˜æ¯”ï¼ˆé»˜è®¤ 16:9ï¼‰
            const screenRatio = containerWidth / containerHeight;

            // è®¡ç®—ç²¾ç¡®åˆ—æ•°ï¼ˆå‚è€ƒ Python è„šæœ¬çš„ç®—æ³•ï¼‰
            // cols_precise = screen_ratio * height * rows / width
            // videoAspectRatio = width / heightï¼Œæ‰€ä»¥ height / width = 1 / videoAspectRatio
            const colsPrecise = screenRatio * rows / videoAspectRatio;

            console.log(`è®¡ç®—ç²¾ç¡®åˆ—æ•°: screenRatio=${screenRatio.toFixed(2)}, rows=${rows}, videoAspectRatio=${videoAspectRatio.toFixed(2)}, colsPrecise=${colsPrecise.toFixed(2)}`);

            // ä»¥ç²¾ç¡®åˆ—æ•°ä¸ºåŸºå‡†ï¼Œç”Ÿæˆå€™é€‰åˆ—æ•°ï¼ˆÂ±2ï¼‰
            const baseCols = Math.round(colsPrecise);
            const candidateCols = [baseCols - 2, baseCols - 1, baseCols, baseCols + 1, baseCols + 2]
                .filter(cols => cols > 0); // è¿‡æ»¤æ‰å°äºç­‰äº0çš„å€¼

            console.log(`å€™é€‰åˆ—æ•°: ${candidateCols.join(', ')}`);

            // è®¡ç®—æ¯ä¸ªå€™é€‰åˆ—æ•°çš„å±å æ¯”
            const candidateColsRatio = candidateCols.map(cols => (videoAspectRatio * cols) / rows);
            const candidateColsScreenToBodyRatio = candidateColsRatio.map(ratio =>
                ratio <= screenRatio ? ratio / screenRatio : screenRatio / ratio
            );

            const results = candidateCols.map((cols, index) => ({
                cols,
                ratio: candidateColsRatio[index],
                screenToBodyRatio: candidateColsScreenToBodyRatio[index]
            }));

            console.log(`è®¡ç®—ç»“æœ: ${results.map(r => `åˆ—æ•°${r.cols}: ${Math.round(r.screenToBodyRatio * 100)}%`).join(', ')}`);

            // æ‰¾åˆ°å±å æ¯”æœ€é«˜çš„åˆ—æ•°
            const maxResult = results.reduce((max, current) =>
                current.screenToBodyRatio > max.screenToBodyRatio ? current : max
            );

            console.log(`æœ€å¤§å±å æ¯”åˆ—æ•°ç»“æœï¼šåˆ—æ•°ã€${maxResult.cols}ã€‘ï¼Œå±å æ¯”ã€${Math.round(maxResult.screenToBodyRatio * 100)}%ã€‘`);

            return maxResult.cols;
        }

        function updateGrid() {
            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨è®¡ç®—ï¼Œå…ˆè®¡ç®—åˆ—æ•°
            const checkbox = document.getElementById('autoCalculateCols');
            if (checkbox.checked) {
                calculateAndSetCols();
            }

            app.updateGridDisplay();
            // ç½‘æ ¼å¤§å°æ”¹å˜æ—¶é‡ç½®ç½‘æ ¼çŠ¶æ€ï¼Œå¼ºåˆ¶é‡æ–°åˆ›å»º
            app.resetGridState();
            app.updatePreviewDebouncedWrapper();
        }

        function updatePreview() {
            app.updatePreviewDebouncedWrapper();
        }

        function setDuration(seconds) {
            document.getElementById('duration').value = seconds;
            updateQuickButtons();
            // æ—¶é•¿æ”¹å˜æ—¶é‡ç½®ç½‘æ ¼çŠ¶æ€ï¼Œå¼ºåˆ¶é‡æ–°åˆ›å»º
            app.resetGridState();
            app.updatePreviewDebouncedWrapper();
        }

        // åŒæ—¶è°ƒæ•´è¡Œåˆ—æ•°
        function changeBothGridSize(direction) {
            changeGridSize(1, direction);
            changeGridSize(2, direction);
            updateGrid();
        }

        // å®«æ ¼æ•°å¢å‡å‡½æ•°
        function changeGridSize(inputId, direction) {
            const input = document.getElementById(inputId === 1 ? 'gridSize' : 'gridSize2');
            const currentValue = parseInt(input.value);
            const minValue = parseInt(input.min);
            const maxValue = parseInt(input.max);
            const newValue = currentValue + direction;

            // ç¡®ä¿å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (newValue >= minValue && newValue <= maxValue) {
                input.value = newValue;
                updateGrid();
            }
        }

        // Tab åˆ‡æ¢å‡½æ•°
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰ Tab æŒ‰é’®çš„ active ç±»
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // éšè—æ‰€æœ‰ Tab å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // è·å–æ–‡ä»¶åˆ—è¡¨åŒºåŸŸå…ƒç´ 
            const fileListSection = document.getElementById('fileListSection');

            // æ¿€æ´»é€‰ä¸­çš„ Tab
            if (tabName === 'local') {
                document.querySelector('.tab-button:nth-child(1)').classList.add('active');
                document.getElementById('localTab').classList.add('active');
                // å¦‚æœæœ‰æœ¬åœ°æ–‡ä»¶ï¼Œåˆ™æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                if (app.videoFiles.length > 0) {
                    fileListSection.classList.remove('is-hidden');
                }
            } else if (tabName === 'remote') {
                document.querySelector('.tab-button:nth-child(2)').classList.add('active');
                document.getElementById('remoteTab').classList.add('active');
                // è¿œç¨‹æ¨¡å¼ä¸‹ï¼Œéšè—æ–‡ä»¶åˆ—è¡¨
                fileListSection.classList.add('is-hidden');
            }
        }

        // æ›´æ–°å¿«æ·æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
        function updateQuickButtons() {
            const currentDuration = parseInt(document.getElementById('duration').value);
            const buttons = document.querySelectorAll('.quick-btn');
            buttons.forEach(btn => {
                const btnText = btn.textContent;
                let btnValue;
                if (btnText.includes('åˆ†é’Ÿ')) {
                    btnValue = parseInt(btnText.replace(/[^0-9]/g, '')) * 60;
                } else {
                    btnValue = parseInt(btnText.replace(/[^0-9]/g, ''));
                }

                if (btnValue === currentDuration) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // å¤„ç†è¿œç¨‹URLè¾“å…¥æ¡†çš„å›è½¦é”®äº‹ä»¶
        function handleRemoteUrlKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const url = document.getElementById('remoteUrlInput').value;
                app.loadRemoteVideo(url);
            }
        }

        // æ¸…ç©ºè¿œç¨‹URLè¾“å…¥æ¡†
        function clearRemoteUrlInput() {
            const input = document.getElementById('remoteUrlInput');
            input.value = '';
            input.focus();
        }
    </script>
</body>

</html>