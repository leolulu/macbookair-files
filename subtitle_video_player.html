<!DOCTYPE html>
<html>

<head>
    <title>Video Player with Subtitles</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        .container-layout-normal {
            flex-direction: row;
        }

        .container-layout-reversed {
            flex-direction: row-reverse;
        }

        #video-player {
            width: 66%;
            overflow: auto;
            align-self: flex-start;
        }

        .video-layout-normal {
            margin-left: 0px;
        }

        .video-layout-reversed {
            margin-left: -4px;
        }

        #video {
            width: 100%;
            display: block;
        }

        #divider {
            cursor: col-resize;
            border-left: 1px solid #aaa;
            width: 4px;
            z-index: 2;
        }

        #subtitles {
            width: 33%;
            overflow: auto;
            height: 99.9vh;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
        }

        .subtitle {
            cursor: pointer;
            padding-top: 2px;
            padding-bottom: 3px;
            border-bottom: 1px dashed #d1c4c4;
            font-size: 18px;
            font-family: PingFang SC, Hiragino Sans GB, Microsoft Yahei, Arial, sans-serif;
            position: relative;
            border-right: 10px solid transparent;
            line-height: 28px;
        }

        .subtitle:nth-child(even) {
            color: #C2571A;
        }

        .subtitle:nth-child(odd) {
            color: #107896;
        }

        .subtitle:hover {
            color: #7b1fa2;
            border-right: 10px solid #E0E0E0;
        }

        .subtitle-word.highlight {
            color: #FFFFFF;
            background-color: #336DF4;
        }

        .subtitle.highlight {
            border-right: 10px solid red;
            background-image: url('data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAANSURBVBhXY3j58uV/AAk1A7vMebz/AAAAAElFTkSuQmCC');
        }

        .transparent-sentence {
            color: transparent;
            position: absolute;
            left: 0;
            top: 2px;
            pointer-events: none;
            user-select: none;
        }

        #videoFileNameContainer {
            display: flex;
            flex-direction: row-reverse;
            margin: 10px;
        }

        #videoFileName {

            font-weight: 800;
            color: #28569F;
        }

        #horizontal-divider {
            cursor: ns-resize;
            border-top: 1px solid #aaa;
            height: 5px;
        }

        #textLength,
        #mediaGain {
            max-width: 2rem;
        }

        #videoUrl {
            max-width: 9rem;
        }

        #skipInterval {
            max-width: 2.2rem;
        }

        #timeConcat {
            max-width: 3rem;
        }

        .censored {
            filter: blur(5px);
            transition: filter 0.2s ease;
        }

        .censored:hover {
            filter: none;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .blinking {
            animation: blink 0.25s ease infinite;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="video-player">
            <video id="video" controls preload="auto" crossorigin="anonymous">
                Your browser does not support HTML5 video.
            </video>
            <div id="horizontal-divider"></div>
            <input type="file" id="videoFile" accept=".mp4, .srt, .json" multiple />
            <label for="skipBlanks">跳过空白</label>
            <input type="checkbox" id="skipBlanks" />
            <label for="enableSkipInterval">空白cap:</label>
            <input type="number" id="skipInterval" value="0.5" step="0.1">
            <input type="checkbox" id="enableSkipInterval" />
            <label for="clickToPlay">点击字幕播放</label>
            <input type="checkbox" id="clickToPlay" />
            <label for="textLength">句长:</label>
            <input type="number" id="textLength" value="1">
            <label for="enableTimeConcat">合并句间隔:</label>
            <input type="text" id="timeConcat" value="0.001">
            <input type="checkbox" id="enableTimeConcat" />
            <label for="hideControl">隐藏播放器控件</label>
            <input type="checkbox" id="hideControl" />
            <label for="toggleLayout">反转布局</label>
            <input type="checkbox" id="toggleLayout" />
            <label for="mediaGain">强制放大音量:</label>
            <input type="number" id="mediaGain" value="1">
            <input type="text" id="videoUrl" placeholder="粘贴视频url,弹框选字幕">
            <button id="loadVideoUrl">加载</button>
            <input type="file" id="VideoUrlWithFile" accept=".srt, .json" multiple style="display:none;" />
            <!-- 添加一个元素用来显示视频文件名 -->
            <div id="videoFileNameContainer">
                <span id="videoFileName"></span>
            </div>
        </div>
        <div id="divider"></div>
        <div id="subtitles">
            <!-- Subtitles will be loaded here -->
        </div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        var isResizing = false;
        var isResizingVertically = false;

        // 通过拖动水平分割线调整视频高度
        $(function () {
            var video = $('#video');

            $('#toggleLayout').change(function () {
                if ($(this).is(':checked')) {
                    $('#container').addClass('container-layout-reversed').removeClass('container-layout-normal');
                    $('#video-player').addClass('video-layout-reversed').removeClass('video-layout-normal');
                } else {
                    $('#container').addClass('container-layout-normal').removeClass('container-layout-reversed');
                    $('#video-player').addClass('video-layout-normal').removeClass('video-layout-reversed');
                }
            });

            var needInitAudioCtx = true;
            var gainNode = null;
            $('#mediaGain').on('input', () => {
                if (needInitAudioCtx) {
                    var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    gainNode = audioCtx.createGain();
                    var mediaElementSource = audioCtx.createMediaElementSource(document.getElementById("video"));
                    mediaElementSource.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    needInitAudioCtx = false;
                }
                gainNode.gain.value = parseInt(document.getElementById("mediaGain").value, 10);
            });

            const hideControlsStyle = document.createElement('style');
            hideControlsStyle.innerHTML = `
                video::-webkit-media-controls-panel {
                    display: none !important;
                }
                video::-webkit-media-controls-play-button {
                    display: none !important;
                }
            `;

            video.on('mouseenter', function () {
                var hideControl = $('#hideControl').prop('checked');
                if (document.head.contains(hideControlsStyle) && !hideControl) {
                    document.head.removeChild(hideControlsStyle);
                }
            });
            video.on('mouseleave', function () {
                if (video.prop('readyState') == 4) {
                    document.head.appendChild(hideControlsStyle);
                }
            });

            var horizontalDivider = $('#horizontal-divider');

            horizontalDivider.on('mousedown', function (e) {
                e.preventDefault();
                isResizingVertically = true;
            });

            $(document).on('mousemove', function (e) {
                if (!isResizingVertically) return;

                var y = e.clientY;

                var videoHeight = (y - video.offset().top);

                video.css('height', videoHeight + 'px');
            }).on('mouseup', function (e) {
                isResizingVertically = false;
            });
        });

        // 通过拖动垂直分割线调整视频和字幕区域的水平比例
        $(function () {
            var videoPlayer = $('#video-player');
            var subtitles = $('#subtitles');
            var divider = $('#divider');

            divider.on('mousedown', function (e) {
                e.preventDefault();
                isResizing = true;
            });

            $(document).on('mousemove', function (e) {
                if (!isResizing) return;

                var x = e.clientX;

                if ($('#toggleLayout').prop('checked')) {
                    var subtitlesWidth = x - subtitles.offset().left;
                    var videoPlayerWidth = window.innerWidth - subtitlesWidth - divider.width();
                } else {
                    var videoPlayerWidth = (x - videoPlayer.offset().left);
                    var subtitlesWidth = window.innerWidth - videoPlayerWidth - divider.width();
                }

                videoPlayer.css('width', videoPlayerWidth + 'px');
                subtitles.css('width', subtitlesWidth + 'px');
            }).on('mouseup', function (e) {
                isResizing = false;
            });
        });

        $(function () {
            // 通过特定区域（视频名称）调整视频播放器的垂直位置
            $('#videoFileName').on('mousedown', function (e) {
                e.preventDefault();
                $('#video-player').draggable({ axis: 'y' });
            });

            $('#videoFileName').on('mouseup', function (e) {
                e.preventDefault();
                $('#video-player').draggable('destroy');
            });

            function extractFilename(urlString) {
                try {
                    var url = new URL(urlString);
                    var decodedPathname = decodeURIComponent(url.pathname);
                    return decodedPathname.split('/').pop();
                } catch (error) {
                    console.error("Invalid URL:", error);
                    return null;
                }
            }

            function updateVideoSource() {
                var videoUrl = document.getElementById('videoUrl').value;
                var videoElement = document.getElementById('video');
                if (videoUrl) {
                    videoElement.src = videoUrl;
                    document.getElementById("VideoUrlWithFile").click();
                    document.title = extractFilename(videoUrl)
                    $('#videoFileName').text(extractFilename(videoUrl));
                    document.getElementById('videoUrl').value = "";
                } else {
                    var element = document.getElementById("videoUrl");
                    element.classList.add("blinking");
                    setTimeout(function () {
                        element.classList.remove("blinking");
                    }, 500);
                }
            }
            document.getElementById('loadVideoUrl').addEventListener('click', updateVideoSource);

            var subtitles = [];
            var tempSubtitles = [];
            var srtLoaded = false

            function clearAllSub() {
                var bigDiv = $('#subtitles')[0]
                while (bigDiv.firstChild) {
                    bigDiv.removeChild(bigDiv.firstChild);
                }
            }

            function accTime(num) {
                return parseFloat(num.toFixed(3));
            }

            function processFiles(e) {
                clearAllSub()
                var files = e.target.files;
                for (var i = 0; i < files.length; i++) {
                    if (files[i].name.endsWith('.mp4')) {
                        var url = URL.createObjectURL(files[i]);
                        $('#video').attr('src', url);
                        document.title = files[i].name;
                        // 更新视频文件名
                        $('#videoFileName').text(files[i].name);
                    } else if (files[i].name.endsWith('.srt')) {
                        srtLoaded = true
                        loadSubtitles(files[i]);
                    } else if (files[i].name.endsWith('.json')) {
                        srtLoaded = false
                        loadDiarizationInfo(files[i]);
                        loadSubtitlesFromJSON(files[i]);
                    }
                }
            }

            // Set up event listener for video file input
            $('#videoFile').change(processFiles);
            $('#VideoUrlWithFile').change(processFiles);

            function loadSubtitlesFromJSONImpl(triggeredFromSentenceLength = false) {
                subtitles = [];
                // Combine short subtitles
                var i = 0;
                while (i < tempSubtitles.length) {
                    var sentence_div = document.createElement('div');
                    var sentence_text = tempSubtitles[i].text;
                    var sentence_start = tempSubtitles[i].start;
                    var sentence_end = tempSubtitles[i].end;

                    function appendWords() {
                        var words = tempSubtitles[i].words;
                        words.forEach(function (word) {
                            var word_span = document.createElement('span');
                            word_span.innerText = word.word;
                            word_span.style.cursor = 'pointer';
                            word_span.onclick = function (event) {
                                event.stopPropagation();
                                video.currentTime = accTime(word.start);
                                if ($('#clickToPlay').prop('checked')) {
                                    $('#video')[0].play();
                                }
                                $('#video')[0].focus();
                            };
                            word_span.setAttribute('data-start', accTime(word.start));
                            word_span.setAttribute('data-end', accTime(word.end));
                            word_span.className = 'subtitle-word'
                            sentence_div.appendChild(word_span);
                        });
                    }

                    appendWords()

                    function whileCondition(i) {
                        if (triggeredFromSentenceLength) {
                            let minLength = parseInt(document.getElementById("textLength").value, 10);
                            return sentence_text.length < minLength
                        } else {
                            let checked = $('#enableTimeConcat').prop('checked')
                            let adjacent = tempSubtitles[i + 1].start - sentence_end < parseFloat(document.getElementById('timeConcat').value)
                            return checked && adjacent
                        }
                    }

                    while (i + 1 < tempSubtitles.length && whileCondition(i)) {
                        i++;
                        sentence_text += "，" + tempSubtitles[i].text;
                        sentence_end = tempSubtitles[i].end;
                        let span = document.createElement('span');
                        span.textContent = "，";
                        (function (currentI) {
                            span.onclick = function (event) {
                                event.stopPropagation();
                                video.currentTime = tempSubtitles[currentI].start;
                                if ($('#clickToPlay').prop('checked')) {
                                    $('#video')[0].play();
                                }
                                $('#video')[0].focus();
                            };
                        })(i)
                        sentence_div.append(span);
                        appendWords()
                    }
                    subtitles.push({ start: sentence_start, end: sentence_end, text: sentence_text });
                    sentence_div.className = 'subtitle';
                    sentence_div.setAttribute('data-index', subtitles.length - 1);
                    sentence_div.setAttribute('data-sentence-start', sentence_start);
                    sentence_div.setAttribute('data-sentence-end', sentence_end);

                    var transparent_sentence_div = document.createElement('div');
                    transparent_sentence_div.textContent = sentence_text;
                    transparent_sentence_div.className = 'transparent-sentence';
                    sentence_div.append(transparent_sentence_div);

                    $('#subtitles').append(sentence_div)
                    i++;
                }
                // Set up event listener for clicking on subtitles
                $('.subtitle').click(function () {
                    var index = $(this).data('index');
                    $('#video')[0].currentTime = subtitles[index].start;
                    if ($('#clickToPlay').prop('checked')) {
                        $('#video')[0].play();
                    }
                    $('#video')[0].focus();
                });
                $('#subtitles').css('width', window.innerWidth - $('#video-player').width() - $('#divider').width() + 'px');
            }


            function loadSubtitlesFromJSON(file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    var asr_data = JSON.parse(event.target.result).asr_info;

                    tempSubtitles = [];

                    asr_data.forEach(function (sentence) {
                        tempSubtitles.push({ start: accTime(sentence.start), end: accTime(sentence.end), text: sentence.text.trim(), words: sentence.words });
                    });

                    loadSubtitlesFromJSONImpl();
                };
                reader.readAsText(file);
            }

            function callLoadSubtitlesFromJSONImpl() {
                var regex = /^[+]?\d+(\.\d+)?$/;
                if (regex.test($('#timeConcat').val())) {
                    clearAllSub()
                    loadSubtitlesFromJSONImpl()
                } else {
                    console.log('说话人间隔数值不合法...')
                }
            }

            $('#enableTimeConcat').on('change', callLoadSubtitlesFromJSONImpl);
            $('#timeConcat').on('input', callLoadSubtitlesFromJSONImpl);

            function reloadSubtitleBySentenceLength() {
                clearAllSub()
                if (srtLoaded) {
                    loadSubtitlesImpl()
                } else {
                    loadSubtitlesFromJSONImpl(triggeredFromSentenceLength = true)
                }
            }

            $('#textLength').on('input', reloadSubtitleBySentenceLength);


            function loadDiarizationInfo(file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const data = JSON.parse(event.target.result);
                    const diarizationInfo = data.diarization_info;
                    const videoDuration = data.video_duration;

                    // Determine unique labels and assign them a vertical position
                    const labels = [...new Set(diarizationInfo.map(info => info.label))];
                    const labelHeights = {};
                    const heightIncrement = 100 / labels.length;
                    labels.forEach((label, index) => {
                        labelHeights[label] = index * heightIncrement;
                    });

                    // Process the data
                    visualizeSpeakers(diarizationInfo, labelHeights, heightIncrement, labels, videoDuration);
                };
                reader.readAsText(file);
            }

            function visualizeSpeakers(diarizationInfo, labelHeights, heightIncrement, labels, videoDuration) {
                const video = document.getElementById('video');
                const videoPlayer = document.getElementById('video-player');

                const existingContainer = document.getElementById('speaker-container');
                if (existingContainer) {
                    videoPlayer.removeChild(existingContainer);
                }

                const container = document.createElement('div');
                container.id = 'speaker-container';  // Assigning an ID to the container for easy reference
                container.style.border = '1px solid #aaa';
                container.style.height = (Object.keys(labelHeights).length * 40) + 'px'; // Adjust height based on number of speakers
                container.style.position = 'relative';
                container.style.marginTop = '10px';
                container.style.overflow = 'hidden';

                // Define a set of colors
                const colors = ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33', '#a65628', '#f781bf'];

                diarizationInfo.forEach(info => {
                    const speakerDiv = document.createElement('div');
                    const startPercentage = (info.start / videoDuration) * 100;
                    const endPercentage = (info.end / videoDuration) * 100;

                    speakerDiv.style.position = 'absolute';
                    speakerDiv.style.top = labelHeights[info.label] + '%';
                    speakerDiv.style.height = heightIncrement + '%';
                    speakerDiv.style.left = startPercentage + '%';
                    speakerDiv.style.width = (endPercentage - startPercentage) + '%';
                    speakerDiv.style.background = colors[labels.indexOf(info.label) % colors.length];
                    speakerDiv.title = info.label;

                    container.appendChild(speakerDiv);
                });

                // Create and add the progress line to the container
                const progressLine = document.createElement('div');
                progressLine.style.position = 'absolute';
                progressLine.style.top = '0';
                progressLine.style.bottom = '0';
                progressLine.style.width = '1px';
                progressLine.style.background = '#000000';  // Color of the progress line
                container.appendChild(progressLine);

                // Update the position of the progress line based on the video's current time
                video.addEventListener('timeupdate', function () {
                    const progressPercentage = (video.currentTime / videoDuration) * 100;
                    progressLine.style.left = progressPercentage + '%';
                });

                // Jump to the clicked position in the video
                container.addEventListener('click', function (event) {
                    let clickPosition = event.offsetX;
                    // Adjust the click position if the target is a speakerDiv
                    if (event.target !== container) {
                        clickPosition += event.target.offsetLeft;
                    }
                    const containerWidth = container.offsetWidth;
                    const clickedPercentage = (clickPosition / containerWidth);
                    video.currentTime = clickedPercentage * videoDuration;
                    $('#video')[0].focus();
                });

                videoPlayer.appendChild(container);

            }


            // Set up event listener for video time updates
            function highlightSubtitle() {
                var currentTime = accTime($('#video')[0].currentTime);
                var found = false;
                for (var i = 0; i < subtitles.length; i++) {
                    if (currentTime >= subtitles[i].start && currentTime < subtitles[i].end) {
                        $('.subtitle').removeClass('highlight');
                        var activeSubtitle = $('.subtitle[data-index=' + i + ']');
                        activeSubtitle.addClass('highlight');

                        // Check if active subtitle is in the viewport
                        var subtitlesBox = $('#subtitles');
                        var scrollTop = subtitlesBox.scrollTop();
                        var scrollBottom = scrollTop + subtitlesBox.height();
                        var activeSubtitleTop = activeSubtitle.position().top + scrollTop;
                        var activeSubtitleBottom = activeSubtitleTop + activeSubtitle.height();

                        if (activeSubtitleTop < scrollTop || activeSubtitleBottom > scrollBottom - 34) {
                            // Scroll to active subtitle
                            subtitlesBox.scrollTop(activeSubtitleTop - 33);
                        }
                        found = true;
                        break;
                    }
                }

                document.querySelectorAll('.subtitle-word').forEach(function (span) {
                    let start = parseFloat(span.getAttribute('data-start'));
                    let end = parseFloat(span.getAttribute('data-end'));
                    if (currentTime >= start && currentTime < end) {
                        $('.subtitle-word').removeClass('highlight');
                        $(span).addClass('highlight');
                    }
                })

                if (!found) {
                    $('.subtitle').removeClass('highlight');
                    $('.subtitle-word').removeClass('highlight');
                }

                var skipBlanks = $('#skipBlanks').prop('checked');
                var skipIntervalChecked = $('#enableSkipInterval').prop('checked');
                var skipInterval = parseFloat(document.getElementById('skipInterval').value);
                var currentSubtitleIndex = subtitles.findIndex(function (subtitle) {
                    return subtitle.start <= currentTime && (skipIntervalChecked ? subtitle.start + skipInterval : subtitle.end) > currentTime;
                });
                if (skipBlanks && currentSubtitleIndex == -1) {
                    var nextSubtitle = subtitles.find(function (subtitle) {
                        return subtitle.start > currentTime;
                    });
                    if (nextSubtitle) {
                        $('#video')[0].currentTime = nextSubtitle.start;
                    } else {
                        $('#video')[0].currentTime = $('#video')[0].duration;
                        $('#video')[0].pause();
                        $('#skipBlanks').trigger('click');
                        setTimeout(() => {
                            $('#skipBlanks').trigger('click');
                        }, 1000);
                    }
                }
            }

            // Listen for timeupdate event to highlight the subtitle
            $('#video').on('timeupdate', highlightSubtitle);

            function loadSubtitlesImpl() {
                subtitles = [];
                // Combine short subtitles
                let minLength = parseInt(document.getElementById("textLength").value, 10);
                var i = 0;
                while (i < tempSubtitles.length) {
                    var text = tempSubtitles[i].text;
                    var start = tempSubtitles[i].start;
                    var end = tempSubtitles[i].end;
                    while (i + 1 < tempSubtitles.length && text.length < minLength) {
                        i++;
                        text += "，" + tempSubtitles[i].text;
                        end = tempSubtitles[i].end;
                    }
                    // text += "。"
                    subtitles.push({ start: start, end: end, text: text });
                    $('#subtitles').append('<div class="subtitle" data-index="' + (subtitles.length - 1) + '">' + text + '</div>');
                    i++;
                }

                // Set up event listener for clicking on subtitles
                $('.subtitle').click(function () {
                    var index = $(this).data('index');
                    $('#video')[0].currentTime = subtitles[index].start;
                    if ($('#clickToPlay').prop('checked')) {
                        $('#video')[0].play();
                    }
                    $('#video')[0].focus();
                });
                $('#subtitles').css('width', window.innerWidth - $('#video-player').width() - $('#divider').width() + 'px');
            }

            function loadSubtitles(file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    // Parse SRT file
                    var data = e.target.result;
                    var lines = data.split('\n');

                    tempSubtitles = []; // Store unprocessed subtitles

                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].indexOf('-->') !== -1) {
                            var times = lines[i].split(' --> ');
                            var start = hmsToSeconds(times[0].trim());
                            var end = hmsToSeconds(times[1].trim());
                            var text = "";
                            for (var j = i + 1; j < lines.length; j++) {
                                if (lines[j].trim() === "") {
                                    i = j;
                                    break;
                                }
                                text += lines[j] + "\n";
                            }
                            tempSubtitles.push({ start: accTime(start), end: accTime(end), text: text.trim() });
                        }
                    }

                    loadSubtitlesImpl()
                };
                reader.readAsText(file);
            }

            function hmsToSeconds(time) {
                time = time.replace('.', ',');
                var parts = time.split(':');
                var secondsParts = parts[2].split(",");
                var hours = parseInt(parts[0], 10);
                var minutes = parseInt(parts[1], 10);
                var seconds = parseInt(secondsParts[0], 10);
                var milliseconds = parseInt(secondsParts[1], 10);
                return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
            }
        });
    </script>
</body>

</html>