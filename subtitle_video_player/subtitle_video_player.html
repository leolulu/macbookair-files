<!DOCTYPE html>
<html>

<head>
    <title>Video Player with Subtitles</title>
    <script src="ass2srtEntry.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        .container-layout-normal {
            flex-direction: row;
        }

        .container-layout-reversed {
            flex-direction: row-reverse;
        }

        #video-player {
            width: 66%;
            overflow: auto;
            align-self: flex-start;
        }

        .video-layout-normal {
            margin-left: 0px;
        }

        .video-layout-reversed {
            margin-left: -4px;
        }

        #video {
            width: 100%;
            display: block;
        }

        #divider {
            cursor: col-resize;
            border-left: 1px solid #aaa;
            width: 4px;
            z-index: 2;
        }

        #subtitles {
            width: 33%;
            overflow: auto;
            height: 99.9vh;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
        }

        .subtitle {
            cursor: pointer;
            padding-top: 2px;
            padding-bottom: 3px;
            border-bottom: 1px dashed #d1c4c4;
            font-size: 18px;
            font-family: PingFang SC, Hiragino Sans GB, Microsoft Yahei, Arial, sans-serif;
            position: relative;
            border-right: 10px solid transparent;
            line-height: 28px;
        }

        .subtitle:nth-child(even) {
            color: #C2571A;
        }

        .subtitle:nth-child(odd) {
            color: #107896;
        }

        .subtitle:hover {
            color: #7b1fa2;
            border-right: 10px solid #E0E0E0;
        }

        .subtitle-word.highlight {
            color: #FFFFFF;
            background-color: #336DF4;
        }

        .subtitle.highlight {
            border-right: 10px solid red;
            background-image: url('data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAANSURBVBhXY3j58uV/AAk1A7vMebz/AAAAAElFTkSuQmCC');
        }

        .transparent-sentence {
            color: transparent;
            position: absolute;
            left: 0;
            top: 2px;
            pointer-events: none;
            user-select: none;
        }

        #videoFileNameContainer {
            display: flex;
            flex-direction: row-reverse;
            justify-content: space-between;
            margin: 10px;
            font-weight: 800;
        }

        .videoFileNameContainer-alternative-margin {
            margin: 7px 10px 10px 10px !important;
        }

        #videoFileName {
            color: #28569F;
        }

        #videoDurationInfo {
            color: #84509d;
            margin-right: 20px;
        }

        #videoDurationInfoMin {
            color: #bca8c5;
            font-size: 10px;
        }

        #horizontal-divider {
            cursor: ns-resize;
            border-top: 1px solid #aaa;
            height: 5px;
        }

        #textLength,
        #mediaGain,
        #sideListSupHeight {
            max-width: 2rem;
        }

        #videoUrl {
            max-width: 9rem;
        }

        #dufsUrl {
            width: 13.1rem;
        }

        #skipInterval,
        #sentenceExtension,
        #scaleSupCaption {
            max-width: 2.2rem;
        }

        #timeConcat {
            max-width: 3rem;
        }

        .none-blur {
            filter: blur(0px);
            transition: filter 0.5s ease;
        }

        .censored {
            filter: blur(5px);
            transition: filter 0.2s ease;
        }

        .censored:hover {
            filter: none;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .blinking {
            animation: blink 0.25s ease infinite;
        }

        #caption {
            position: absolute;
            left: 20px;
            max-width: 80%;
            bottom: 6%;
            color: #FFFFFF;
            text-align: center;
            font-size: 26px;
            font-family: PingFang SC, Hiragino Sans GB, Microsoft Yahei, Arial, sans-serif;
            font-weight: 400;
            line-height: 33px;
            display: none;
        }

        .video_container {
            position: relative;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            z-index: 1001;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            overflow: auto;
            max-height: 90vh;
            max-width: 90vw;
            text-wrap: nowrap;
        }

        #loadSelectedFiles {
            margin-top: 15px;
            margin-right: 20px;
        }

        .progress-container {
            position: relative;
            width: 98%;
            margin-left: 1%;
            margin-right: 1%;
            margin-top: 7px;
            box-sizing: border-box;
            padding: 3px 0 4px 0;
            border: 1px solid #000;
            display: none;
        }

        .progress-bar,
        .progress-bar-temp,
        .progress-bar-shade {
            position: absolute;
            background-color: #000;
            height: 2px;
            width: 0%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }

        #progress-bar-temp {
            z-index: 1;
        }

        #progress-bar-shade {
            z-index: 1;
        }

        #resizable-shade {
            width: 600px;
            height: 40px;
            display: none;
            position: absolute;
            top: 70%;
            left: 25%;
            background-color: #365881;
        }

        .ui-resizable-se-adjust-position {
            width: 9px;
            height: 9px;
            right: -5px;
            bottom: -5px;
        }

        #videoFocusStatus {
            font-weight: bold;
        }

        #ff-sign {
            position: absolute;
            left: 10px;
            top: 10px;
            font-size: 30px;
        }

        .hide-element {
            display: none;
        }

        .hide-element-potently {
            display: none !important;
        }

        .inline-options-container {
            border: 1px dotted green;
            box-sizing: border-box;
            padding: 0 0 0 5px;
            display: inline-block;
        }

        .options-container label {
            white-space: nowrap;
        }

        .warning-sign {
            position: relative;
            top: -2px;
        }

        #subtitles .sup-subtitle-image {
            max-height: 28px;
            max-width: 100%;
        }

        .inline-block-element {
            display: inline-block;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="video-player">
            <div class="video_container">
                <video id="video" controls preload="auto" crossorigin="anonymous">
                    Your browser does not support HTML5 video.
                </video>
                <span id="caption">Â≠óÂπïÔºàÈªòËÆ§‰∏çÊòæÁ§∫ÔºâÔºåÊí≠ÊîæÊó∂Êõ¥Êñ∞</span>
                <div id="ff-sign" class="hide-element">‚è©</div>
                <div id="resizable-shade"></div>
            </div>
            <div id="horizontal-divider"></div>
            <div class="options-container">
                <input type="file" id="videoFile" accept=".mp4, .webm, .srt, .json, .ass, .html" multiple />
                <span id='videoFocusStatus' class="inline-block-element">‚ùå<span style="color: red;">Â§±ÁÑ¶</span></span>
                <span id='videoCanPlayStatus'>üî¥</span>
                <div class="inline-block-element">
                    <label for="skipBlanks">Ë∑≥ËøáÁ©∫ÁôΩ</label>
                    <input type="checkbox" id="skipBlanks" />
                </div>
                <div class="inline-options-container">
                    <label for="enableFFMode">Âø´ËøõÂºèË∑≥Ë∑É</label>
                    <input type="checkbox" id="enableFFMode" />
                    <label for="FFWithoutCalibration">Êó†Ê†°ÂáÜ<span class='warning-sign'>‚ö†Ô∏è</span></label>
                    <input type="checkbox" id="FFWithoutCalibration" />
                </div>
                <div class="inline-block-element">
                    <label for="enableSkipInterval">Á©∫ÁôΩcap:</label>
                    <input type="number" id="skipInterval" value="0.5" step="0.1">
                    <input type="checkbox" id="enableSkipInterval" />
                </div>
                <div class="inline-block-element">
                    <label for="enableSentenceExtension">Âª∂Â±ïÂè•Èïø‚û∞:</label>
                    <input type="number" id="sentenceExtension" value="0.5" step="0.1">
                    <input type="checkbox" id="enableSentenceExtension" />
                </div>
                <div class="inline-block-element">
                    <label for="clickToPlay">ÁÇπÂáªÂ≠óÂπïÊí≠Êîæ</label>
                    <input type="checkbox" id="clickToPlay" />
                </div>
                <div class="inline-options-container">
                    <label for="textLength">Âè•Èïø:</label>
                    <input type="number" id="textLength" value="1">
                    <div class="inline-block-element">
                        <label for="enableTimeConcat">ÂêàÂπ∂Âè•Èó¥Èöîüîó:</label>
                        <input type="number" id="timeConcat" value="0.001" step="0.1">
                        <input type="checkbox" id="enableTimeConcat" />
                    </div>
                </div>
                <div class="inline-block-element">
                    <label for="hideControl">ÈöêËóèÊí≠ÊîæÂô®Êéß‰ª∂</label>
                    <input type="checkbox" id="hideControl" />
                </div>
                <div class="inline-block-element">
                    <label for="toggleLayout">ÂèçËΩ¨Â∏ÉÂ±Ä</label>
                    <input type="checkbox" id="toggleLayout" />
                </div>
                <div class="inline-block-element">
                    <label for="mediaGain">Âº∫Âà∂ÊîæÂ§ßÈü≥Èáèüîä:</label>
                    <input type="number" id="mediaGain" value="1">
                </div>
                <div class="inline-block-element">
                    <input type="text" id="videoUrl" placeholder="Á≤òË¥¥ËßÜÈ¢ëurl,ÂºπÊ°ÜÈÄâÂ≠óÂπï">
                    <button id="loadVideoUrl">Âä†ËΩΩ</button>
                </div>
                <input type="file" id="VideoUrlWithFile" accept=".srt, .json, .ass" multiple style="display:none;" />
                <div class="inline-options-container">
                    <label for="toggleCaptionDisplay">ÊòæÁ§∫Â≠óÂπï</label>
                    <input type="checkbox" id="toggleCaptionDisplay" />
                    <label for="toggleCaptionBackgroundColor">Â≠óÂπïÈªëËâ≤ËÉåÊôØ</label>
                    <input type="checkbox" id="toggleCaptionBackgroundColor" />
                    <label for="toggleCaptionShadow">Â≠óÂπïÊèèËæπ</label>
                    <input type="checkbox" id="toggleCaptionShadow" />
                    <div class="inline-block-element">
                        <label for="scaleSupCaption">supÁº©Êîæ:</label>
                        <input type="number" id="scaleSupCaption" value="1.0" step="0.1">
                    </div>
                    <div class="inline-block-element">
                        <label for="sideListSupHeight">sup‰æßËæπÈ´òÂ∫¶:</label>
                        <input type="number" id="sideListSupHeight" value="28">
                    </div>
                </div>
                <div class="inline-block-element">
                    <input type="text" id="dufsUrl" placeholder='dufsÁõÆÂΩïË∑ØÂæÑ(ÁªìÂ∞æ‰∏çÁî®Âä†"?simple")'>
                    <button id="fetchDufsFiles">Ëé∑ÂèñDufsÂàóË°®</button>
                </div>
                <div class="inline-block-element">
                    <label for="toggleSubtileShade">Â≠óÂπïÈÅÆÁΩ©Âô®</label>
                    <input type="checkbox" id="toggleSubtileShade" />
                </div>
                <div class="inline-block-element">
                    <label for="blurAllSub">Ê®°Á≥ä‰æßËæπÂ≠óÂπï</label>
                    <input type="checkbox" id="blurAllSub" />
                </div>
            </div>
            <div class="progress-container" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
                <div class="progress-bar-temp" id="progress-bar-temp"></div>
                <div class="progress-bar-shade" id="progress-bar-shade"></div>
            </div>
            <!-- Ê∑ªÂä†‰∏Ä‰∏™ÂÖÉÁ¥†Áî®Êù•ÊòæÁ§∫ËßÜÈ¢ëÊñá‰ª∂Âêç -->
            <div id="videoFileNameContainer">
                <span id="videoFileName"></span>
                <span id="videoDurationInfo"></span>
            </div>
        </div>
        <div id="divider"></div>
        <div id="subtitles">
            <!-- Subtitles will be loaded here -->
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay">
        <div id="fileListContainer" class="modal">
            <div id="fileList"></div>
            <button id="loadSelectedFiles">Âä†ËΩΩÈÄâ‰∏≠Êñá‰ª∂</button>
            <button id="closeFileList">ÂÖ≥Èó≠</button>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script>
        var isResizing = false;
        var isResizingVertically = false;

        // ÈÄöËøáÊãñÂä®Ê∞¥Âπ≥ÂàÜÂâ≤Á∫øË∞ÉÊï¥ËßÜÈ¢ëÈ´òÂ∫¶
        $(function () {
            var video = $('#video');

            $('#toggleLayout').change(function () {
                if ($(this).is(':checked')) {
                    $('#container').addClass('container-layout-reversed').removeClass('container-layout-normal');
                    $('#video-player').addClass('video-layout-reversed').removeClass('video-layout-normal');
                } else {
                    $('#container').addClass('container-layout-normal').removeClass('container-layout-reversed');
                    $('#video-player').addClass('video-layout-normal').removeClass('video-layout-reversed');
                }
            });

            var needInitAudioCtx = true;
            var gainNode = null;
            $('#mediaGain').on('input', () => {
                if (needInitAudioCtx) {
                    var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    gainNode = audioCtx.createGain();
                    var mediaElementSource = audioCtx.createMediaElementSource(document.getElementById("video"));
                    mediaElementSource.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    needInitAudioCtx = false;
                }
                gainNode.gain.value = parseInt(document.getElementById("mediaGain").value, 10);
            });

            const hideControlsStyle = document.createElement('style');
            hideControlsStyle.innerHTML = `
                video::-webkit-media-controls-panel {
                    display: none !important;
                }
                video::-webkit-media-controls-play-button {
                    display: none !important;
                }
            `;

            video.on('mouseenter', function () {
                var hideControl = $('#hideControl').prop('checked');
                if (document.head.contains(hideControlsStyle) && !hideControl) {
                    document.head.removeChild(hideControlsStyle);
                }
            });
            video.on('mouseleave', function () {
                if (video.prop('readyState') == 4) {
                    document.head.appendChild(hideControlsStyle);
                }
            });

            $('#hideControl').change(function () {
                $('#progress-container').toggle(this.checked);
                if (this.checked) {
                    $('#videoFileNameContainer').addClass('videoFileNameContainer-alternative-margin')
                } else {
                    $('#videoFileNameContainer').removeClass('videoFileNameContainer-alternative-margin')
                }
            });

            $('#toggleSubtileShade').change(function () {
                $('#resizable-shade').toggle(this.checked);
            });

            var horizontalDivider = $('#horizontal-divider');

            horizontalDivider.on('mousedown', function (e) {
                e.preventDefault();
                isResizingVertically = true;
            });

            $(document).on('mousemove', function (e) {
                if (!isResizingVertically) return;

                var y = e.clientY;

                var videoHeight = (y - video.offset().top);

                video.css('height', videoHeight + 'px');
            }).on('mouseup', function (e) {
                isResizingVertically = false;
            });
        });

        // ÈÄöËøáÊãñÂä®ÂûÇÁõ¥ÂàÜÂâ≤Á∫øË∞ÉÊï¥ËßÜÈ¢ëÂíåÂ≠óÂπïÂå∫ÂüüÁöÑÊ∞¥Âπ≥ÊØî‰æã
        $(function () {
            var videoPlayer = $('#video-player');
            var subtitles = $('#subtitles');
            var divider = $('#divider');

            divider.on('mousedown', function (e) {
                e.preventDefault();
                isResizing = true;
            });

            $(document).on('mousemove', function (e) {
                if (!isResizing) return;

                var x = e.clientX;

                if ($('#toggleLayout').prop('checked')) {
                    var subtitlesWidth = x - subtitles.offset().left;
                    var videoPlayerWidth = window.innerWidth - subtitlesWidth - divider.width();
                } else {
                    var videoPlayerWidth = (x - videoPlayer.offset().left);
                    var subtitlesWidth = window.innerWidth - videoPlayerWidth - divider.width();
                }

                videoPlayer.css('width', videoPlayerWidth + 'px');
                subtitles.css('width', subtitlesWidth + 'px');
            }).on('mouseup', function (e) {
                isResizing = false;
            });
        });

        $(function () {
            // ÈÄöËøáÁâπÂÆöÂå∫ÂüüÔºàËßÜÈ¢ëÂêçÁß∞ÔºâË∞ÉÊï¥ËßÜÈ¢ëÊí≠ÊîæÂô®ÁöÑÂûÇÁõ¥‰ΩçÁΩÆ
            $('#videoFileName').on('mousedown', function (e) {
                e.preventDefault();
                $('#video-player').draggable({ axis: 'y' });
            });

            $('#videoFileName').on('mouseup', function (e) {
                e.preventDefault();
                $('#video-player').draggable('destroy');
            });

            function extractFilename(urlString) {
                try {
                    var url = new URL(urlString);
                    var decodedPathname = decodeURIComponent(url.pathname);
                    return decodedPathname.split('/').pop();
                } catch (error) {
                    console.error("Invalid URL:", error);
                    return null;
                }
            }

            function updateVideoSource() {
                var videoUrl = document.getElementById('videoUrl').value;
                var videoElement = document.getElementById('video');
                if (videoUrl) {
                    videoElement.src = videoUrl;
                    document.getElementById("VideoUrlWithFile").click();
                    document.title = extractFilename(videoUrl)
                    $('#videoFileName').text(extractFilename(videoUrl));
                    document.getElementById('videoUrl').value = "";
                } else {
                    var element = document.getElementById("videoUrl");
                    element.classList.add("blinking");
                    setTimeout(function () {
                        element.classList.remove("blinking");
                    }, 500);
                }
            }
            document.getElementById('loadVideoUrl').addEventListener('click', updateVideoSource);

            var subtitles = [];
            var tempSubtitles = [];
            var srtLoaded = false

            function clearAllSub() {
                var bigDiv = $('#subtitles')[0]
                while (bigDiv.firstChild) {
                    bigDiv.removeChild(bigDiv.firstChild);
                }
            }

            function accTime(num) {
                return parseFloat(num.toFixed(3));
            }

            async function processFilesImpl(files) {
                for (var i = 0; i < files.length; i++) {
                    if (files[i].name.toLowerCase().endsWith('.mp4') || files[i].name.toLowerCase().endsWith('.webm')) {
                        var url = URL.createObjectURL(files[i]);
                        $('#video').attr('src', url);
                        document.title = files[i].name;
                        // Êõ¥Êñ∞ËßÜÈ¢ëÊñá‰ª∂Âêç
                        $('#videoFileName').text(files[i].name);
                    } else if (files[i].name.toLowerCase().endsWith('.ass')) {
                        srtLoaded = true
                        await loadSubtitles(files[i], formatIsAss = true);
                    } else if (files[i].name.toLowerCase().endsWith('.srt')) {
                        srtLoaded = true
                        await loadSubtitles(files[i]);
                    } else if (files[i].name.toLowerCase().endsWith('.json')) {
                        if (!srtLoaded) {
                            await loadSubtitlesFromJSON(files[i]);
                        }
                        loadDiarizationInfo(files[i]);
                    } else if (files[i].name.toLowerCase().endsWith('.html')) {
                        await loadHtmlFromSup(files[i])
                    }
                }
            }

            function processFiles(e) {
                srtLoaded = false;
                let files = e.target.files;
                processFilesImpl(files);
            }

            // Set up event listener for video file input
            $('#videoFile').change(processFiles);
            $('#VideoUrlWithFile').change(processFiles);

            function loadHtmlFromSup(file) {
                return new Promise((resolve, reject) => {
                    clearAllSub()
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        const htmlContent = e.target.result;

                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlContent, 'text/html');

                        const divs = doc.querySelectorAll('body > div');
                        tempSubtitles = [];

                        divs.forEach(div => {
                            // Ëé∑ÂèñdivÂÜÖÈÉ®ÁöÑÊñáÊú¨ÔºåÂç≥Êó∂Èó¥Âíå#Âè∑ÂºÄÂ§¥ÁöÑÊñáÊú¨
                            const text = div.previousSibling.textContent.trim();
                            // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂåπÈÖçÊó∂Èó¥ÂíåÂõæÁâáÊ∫ê
                            const match = text.match(/#(\d+):((\d+):)?(\d+):(\d+),(\d+)->((\d+):)?(\d+):(\d+),(\d+)/);
                            const imgSrc = div.querySelector('img').src.split('/').pop()

                            if (match) {
                                // ËΩ¨Êç¢Êó∂Èó¥‰∏∫Áßí
                                const startTime = (parseInt(match[3] || 0) * 3600) + (parseInt(match[4]) * 60) + parseInt(match[5]) + parseInt(match[6]) / 1000;
                                const endTime = (parseInt(match[8] || 0) * 3600) + (parseInt(match[9]) * 60) + parseInt(match[10]) + parseInt(match[11]) / 1000;
                                // Ê∑ªÂä†Âà∞ÁªìÊûúÂàóË°®
                                tempSubtitles.push({
                                    start: accTime(startTime),
                                    end: accTime(endTime),
                                    text: "<img class='sup-subtitle-image' src='sup/" + imgSrc + "' />"
                                });
                            }
                        });

                        loadSubtitlesImpl()
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }

            function loadSubtitlesFromJSONImpl(triggeredFromSentenceLength = false) {
                subtitles = [];
                // Combine short subtitles
                var i = 0;
                while (i < tempSubtitles.length) {
                    var sentence_div = document.createElement('div');
                    var sentence_text = tempSubtitles[i].text;
                    var sentence_start = tempSubtitles[i].start;
                    var sentence_end = tempSubtitles[i].end;

                    function appendWords() {
                        var words = tempSubtitles[i].words;
                        words.forEach(function (word) {
                            var word_span = document.createElement('span');
                            word_span.innerText = word.word;
                            word_span.style.cursor = 'pointer';
                            word_span.onclick = function (event) {
                                event.stopPropagation();
                                video.currentTime = accTime(word.start);
                                if ($('#clickToPlay').prop('checked')) {
                                    $('#video')[0].play();
                                }
                                $('#video')[0].focus();
                            };
                            word_span.setAttribute('data-start', accTime(word.start));
                            word_span.setAttribute('data-end', accTime(word.end));
                            word_span.className = 'subtitle-word'
                            sentence_div.appendChild(word_span);
                        });
                    }

                    appendWords()

                    function whileCondition(i) {
                        if (triggeredFromSentenceLength) {
                            let minLength = parseInt(document.getElementById("textLength").value, 10);
                            return sentence_text.length < minLength
                        } else {
                            let checked = $('#enableTimeConcat').prop('checked')
                            let adjacent = tempSubtitles[i + 1].start - sentence_end < parseFloat(document.getElementById('timeConcat').value)
                            return checked && adjacent
                        }
                    }

                    while (i + 1 < tempSubtitles.length && whileCondition(i)) {
                        i++;
                        sentence_text += "Ôºå" + tempSubtitles[i].text;
                        sentence_end = tempSubtitles[i].end;
                        let span = document.createElement('span');
                        span.textContent = "Ôºå";
                        (function (currentI) {
                            span.onclick = function (event) {
                                event.stopPropagation();
                                video.currentTime = tempSubtitles[currentI].start;
                                if ($('#clickToPlay').prop('checked')) {
                                    $('#video')[0].play();
                                }
                                $('#video')[0].focus();
                            };
                        })(i)
                        sentence_div.append(span);
                        appendWords()
                    }
                    subtitles.push({ start: sentence_start, end: sentence_end, text: sentence_text });
                    sentence_div.className = 'subtitle';
                    sentence_div.setAttribute('data-index', subtitles.length - 1);
                    sentence_div.setAttribute('data-sentence-start', sentence_start);
                    sentence_div.setAttribute('data-sentence-end', sentence_end);

                    var transparent_sentence_div = document.createElement('div');
                    transparent_sentence_div.textContent = sentence_text;
                    transparent_sentence_div.className = 'transparent-sentence';
                    sentence_div.append(transparent_sentence_div);

                    $('#subtitles').append(sentence_div)
                    i++;
                }
                // Set up event listener for clicking on subtitles
                $('.subtitle').click(function () {
                    var index = $(this).data('index');
                    $('#video')[0].currentTime = subtitles[index].start;
                    if ($('#clickToPlay').prop('checked')) {
                        $('#video')[0].play();
                    }
                    $('#video')[0].focus();
                });
                $('#subtitles').css('width', window.innerWidth - $('#video-player').width() - $('#divider').width() + 'px');
            }


            function loadSubtitlesFromJSON(file) {
                return new Promise((resolve, reject) => {
                    clearAllSub()
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        var asr_data = JSON.parse(event.target.result).asr_info;

                        tempSubtitles = [];

                        asr_data.forEach(function (sentence) {
                            tempSubtitles.push({ start: accTime(sentence.start), end: accTime(sentence.end), text: sentence.text.trim(), words: sentence.words });
                        });

                        loadSubtitlesFromJSONImpl();
                        resolve()
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }

            function callLoadSubtitlesFromJSONImpl() {
                var regex = /^[+]?\d+(\.\d+)?$/;
                if (regex.test($('#timeConcat').val())) {
                    clearAllSub()
                    loadSubtitlesFromJSONImpl()
                } else {
                    console.error('ËØ¥ËØù‰∫∫Èó¥ÈöîÊï∞ÂÄº‰∏çÂêàÊ≥ï...')
                }
            }

            $('#enableTimeConcat').on('change', callLoadSubtitlesFromJSONImpl);
            $('#timeConcat').on('input', callLoadSubtitlesFromJSONImpl);

            function reloadSubtitleBySentenceLength() {
                clearAllSub()
                if (srtLoaded) {
                    loadSubtitlesImpl()
                } else {
                    loadSubtitlesFromJSONImpl(triggeredFromSentenceLength = true)
                }
            }

            $('#textLength').on('input', reloadSubtitleBySentenceLength);


            function loadDiarizationInfo(file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const data = JSON.parse(event.target.result);
                    const diarizationInfo = data.diarization_info;
                    const videoDuration = data.video_duration;

                    // Determine unique labels and assign them a vertical position
                    const labels = [...new Set(diarizationInfo.map(info => info.label))];
                    const labelHeights = {};
                    const heightIncrement = 100 / labels.length;
                    labels.forEach((label, index) => {
                        labelHeights[label] = index * heightIncrement;
                    });

                    // Process the data
                    visualizeSpeakers(diarizationInfo, labelHeights, heightIncrement, labels, videoDuration);
                };
                reader.readAsText(file);
            }

            function visualizeSpeakers(diarizationInfo, labelHeights, heightIncrement, labels, videoDuration) {
                const video = document.getElementById('video');
                const videoPlayer = document.getElementById('video-player');

                const existingContainer = document.getElementById('speaker-container');
                if (existingContainer) {
                    videoPlayer.removeChild(existingContainer);
                }

                const container = document.createElement('div');
                container.id = 'speaker-container';  // Assigning an ID to the container for easy reference
                container.style.border = '1px solid #aaa';
                let speakerCount = Object.keys(labelHeights).length;
                let speakerDivHeight = speakerCount <= 4 ? 40 : (speakerCount <= 8 ? 30 : (speakerCount <= 16 ? 20 : 10));
                container.style.height = (speakerCount * speakerDivHeight) + 'px'; // Adjust height based on number of speakers
                container.style.position = 'relative';
                container.style.marginTop = '10px';
                container.style.overflow = 'hidden';

                // Define a set of colors
                const colors = ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33', '#a65628', '#f781bf'];

                diarizationInfo.forEach(info => {
                    const speakerDiv = document.createElement('div');
                    const startPercentage = (info.start / videoDuration) * 100;
                    const endPercentage = (info.end / videoDuration) * 100;

                    speakerDiv.style.position = 'absolute';
                    speakerDiv.style.top = labelHeights[info.label] + '%';
                    speakerDiv.style.height = heightIncrement + '%';
                    speakerDiv.style.left = startPercentage + '%';
                    speakerDiv.style.width = (endPercentage - startPercentage) + '%';
                    speakerDiv.style.background = colors[labels.indexOf(info.label) % colors.length];
                    speakerDiv.title = info.label;

                    container.appendChild(speakerDiv);
                });

                // Create and add the progress line to the container
                const progressLine = document.createElement('div');
                progressLine.style.position = 'absolute';
                progressLine.style.top = '0';
                progressLine.style.bottom = '0';
                progressLine.style.width = '1px';
                progressLine.style.background = '#000000';  // Color of the progress line
                container.appendChild(progressLine);

                // Update the position of the progress line based on the video's current time
                video.addEventListener('timeupdate', function () {
                    const progressPercentage = (video.currentTime / videoDuration) * 100;
                    progressLine.style.left = progressPercentage + '%';
                });

                // Jump to the clicked position in the video
                container.addEventListener('click', function (event) {
                    let clickPosition = event.offsetX;
                    // Adjust the click position if the target is a speakerDiv
                    if (event.target !== container) {
                        clickPosition += event.target.offsetLeft;
                    }
                    const containerWidth = container.offsetWidth;
                    const clickedPercentage = (clickPosition / containerWidth);
                    video.currentTime = clickedPercentage * videoDuration;
                    $('#video')[0].focus();
                });

                videoPlayer.appendChild(container);

            }

            function centerCaption(spanLastLeft = 0) {
                var div = document.querySelector(".video_container")
                var span = document.querySelector('#caption');

                var divWidth = div.offsetWidth;
                var spanWidth = span.offsetWidth;
                var leftPosition = (divWidth - spanWidth) / 2;
                if (leftPosition > 0 && (Math.abs(parseFloat(window.getComputedStyle(span).left) - leftPosition) > 10)) {
                    span.style.left = leftPosition + 'px';
                }

                var spanLeftValue = parseFloat(window.getComputedStyle(span).left);
                if (Math.abs(spanLeftValue - spanLastLeft) < 10) {
                    return
                } else {
                    centerCaption(spanLeftValue)
                }
            }

            document.getElementById('toggleCaptionDisplay').addEventListener('change', function () {
                var span = document.getElementById('caption');
                if (this.checked) {
                    span.style.display = 'inline';
                } else {
                    span.style.display = 'none';
                }
            });

            document.getElementById('toggleCaptionBackgroundColor').addEventListener('change', function () {
                var span = document.getElementById('caption');
                if (this.checked) {
                    span.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                } else {
                    span.style.backgroundColor = '';
                }
            });

            document.getElementById('toggleCaptionShadow').addEventListener('change', function () {
                var span = document.getElementById('caption');
                if (this.checked) {
                    span.style.textShadow = 'black 1px 0px 0,black -1px 0px 0,black 0px 1px 0,black 0px -1px 0,black 1px 1px 0,black -1px -1px 0,black -1px 1px 0,black 1px -1px 0';
                } else {
                    span.style.textShadow = '';
                }
            });

            (function () {
                var checkbox1 = document.getElementById('enableSkipInterval');
                var checkbox2 = document.getElementById('enableSentenceExtension');

                checkbox1.addEventListener('click', function () {
                    if (checkbox1.checked) {
                        checkbox2.checked = false;
                    }
                });

                checkbox2.addEventListener('click', function () {
                    if (checkbox2.checked) {
                        checkbox1.checked = false;
                    }
                });
            })();

            (function () {
                let dropZone = document.getElementById('videoFile');
                dropZone.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    dropZone.style.backgroundColor = '#F7C137';
                });
                dropZone.addEventListener('dragleave', function (e) {
                    e.preventDefault();
                    dropZone.style.backgroundColor = '';
                });
                dropZone.addEventListener('drop', function (e) {
                    e.preventDefault();
                    dropZone.style.backgroundColor = '';
                    srtLoaded = false;
                    let files = e.dataTransfer.files;
                    processFilesImpl(files);
                });
            })();

            var hideVideoSpeedControllerTimer = null;
            function hideVideoSpeedControllerTemporarily() {
                $('div.vsc-controller').addClass('hide-element-potently');
                if (hideVideoSpeedControllerTimer) {
                    clearTimeout(hideVideoSpeedControllerTimer)
                }
                hideVideoSpeedControllerTimer = setTimeout(() => {
                    $('div.vsc-controller').removeClass('hide-element-potently');
                }, 1000);
            }

            var previousSpeed = 1;
            function fastForwardUntilDetach(detach_time, need_calibration = false, fastForwardSpeed = 8) {
                $('#video').off('timeupdate', highlightSubtitle)
                setTimeout(() => {
                    hideVideoSpeedControllerTemporarily();
                    $('#video')[0].playbackRate = previousSpeed;
                    if (need_calibration) {
                        $('#video')[0].currentTime = detach_time;
                    }
                    $('#video').on('timeupdate', highlightSubtitle);
                    $('#ff-sign').addClass('hide-element')
                }, (detach_time - $('#video')[0].currentTime) / fastForwardSpeed * 1000);
                hideVideoSpeedControllerTemporarily();
                $('#video')[0].playbackRate = fastForwardSpeed;
                $('#ff-sign').removeClass('hide-element')
            }

            var hideProgressBarTempTimer = null;
            // Set up event listener for video time updates
            function highlightSubtitle() {
                previousSpeed = $('#video')[0].playbackRate;
                var currentTime = accTime($('#video')[0].currentTime);
                var found = false;
                var first_match_sub_index = null;
                var captions = [];
                $('.subtitle').removeClass('highlight');
                for (var i = 0; i < subtitles.length; i++) {
                    if (currentTime >= subtitles[i].start && currentTime < subtitles[i].end) {
                        var activeSubtitle = $('.subtitle[data-index=' + i + ']');
                        activeSubtitle.addClass('highlight');
                        var transparentSentenceDiv = activeSubtitle.find('.transparent-sentence');
                        var supSubtitleImage = activeSubtitle.find('.sup-subtitle-image');
                        if (transparentSentenceDiv.length) {
                            captions.push(transparentSentenceDiv.text());
                        } else if (supSubtitleImage.length) {
                            supSubtitleImage.each(function (index, element) {
                                captions.push(element.outerHTML);
                            })
                        } else {
                            captions.push(activeSubtitle.text());
                        }
                        // Check if active subtitle is in the viewport
                        var subtitlesBox = $('#subtitles');
                        var scrollTop = subtitlesBox.scrollTop();
                        var scrollBottom = scrollTop + subtitlesBox.height();
                        var activeSubtitleTop = activeSubtitle.position().top + scrollTop;
                        var activeSubtitleBottom = activeSubtitleTop + activeSubtitle.height();

                        if (activeSubtitleTop < scrollTop || activeSubtitleBottom > scrollBottom - 34) {
                            // Scroll to active subtitle
                            subtitlesBox.scrollTop(activeSubtitleTop - 33);
                        }
                        found = true;

                        if (first_match_sub_index !== null && i - first_match_sub_index > 10) {
                            break;
                        } else {
                            first_match_sub_index = i;
                        }
                    }
                }

                if (captions.length > 1) {
                    captions.splice(-1, 0, '-'.repeat(Math.max(...captions.map(item => item.length))));
                }
                $('#caption').html(captions.join('<br>'));

                let captionSup = document.querySelector("#caption img.sup-subtitle-image");
                if (captionSup && !captionSup.getAttribute('data-resized')) {
                    let originalWidth = captionSup.width;
                    let originalHeight = captionSup.height;
                    let ratio = parseFloat(document.getElementById('scaleSupCaption').value)
                    captionSup.style.width = originalWidth * ratio + 'px';
                    captionSup.style.height = originalHeight * ratio + 'px';
                    captionSup.setAttribute("data-resized", true);
                }

                centerCaption()

                document.querySelectorAll('.subtitle-word').forEach(function (span) {
                    let start = parseFloat(span.getAttribute('data-start'));
                    let end = parseFloat(span.getAttribute('data-end'));
                    if (currentTime >= start && currentTime < end) {
                        $('.subtitle-word').removeClass('highlight');
                        $(span).addClass('highlight');
                    }
                })

                if (!found) {
                    $('.subtitle').removeClass('highlight');
                    $('.subtitle-word').removeClass('highlight');
                    $('#caption').text("");
                }

                var skipBlanks = $('#skipBlanks').prop('checked');
                var enableFFMode = $('#enableFFMode').prop('checked');
                var skipIntervalChecked = $('#enableSkipInterval').prop('checked');
                var skipInterval = parseFloat(document.getElementById('skipInterval').value);
                var sentenceExtensionChecked = $('#enableSentenceExtension').prop('checked');
                var sentenceExtension = parseFloat(document.getElementById('sentenceExtension').value);
                var currentSubtitleIndex = subtitles.findIndex(function (subtitle) {
                    if (skipIntervalChecked) {
                        return subtitle.start <= currentTime && (subtitle.end < subtitle.start + skipInterval ? subtitle.end : subtitle.start + skipInterval) > currentTime;
                    } else if (sentenceExtensionChecked) {
                        return accTime(subtitle.start - sentenceExtension) <= currentTime && accTime(subtitle.end + sentenceExtension) > currentTime;
                    } else {
                        return subtitle.start <= currentTime && subtitle.end > currentTime;
                    }
                });
                if (skipBlanks && currentSubtitleIndex == -1) {
                    var nextSubtitle = subtitles.find(function (subtitle) {
                        return subtitle.start > currentTime;
                    });
                    if (nextSubtitle) {
                        var nextSubtitleStartTime = sentenceExtensionChecked ? accTime(nextSubtitle.start - sentenceExtension) : nextSubtitle.start;
                        if (enableFFMode) {
                            let duration = nextSubtitleStartTime - currentTime;
                            if (duration > 1) {
                                let fastForwardSpeed = 8;
                                for (let s = 2; s < 8; s++) {
                                    if (duration <= s * 2) {
                                        fastForwardSpeed = s;
                                        break;
                                    }
                                }
                                if (previousSpeed > 1) {
                                    fastForwardSpeed *= previousSpeed;
                                }
                                fastForwardUntilDetach(nextSubtitleStartTime, $('#FFWithoutCalibration').prop('checked') ? false : duration > 3, fastForwardSpeed);
                            }
                        } else {
                            $('#video')[0].currentTime = nextSubtitleStartTime;
                        }
                    } else {
                        if (enableFFMode) {
                            fastForwardUntilDetach($('#video')[0].duration);
                        } else {
                            $('#video')[0].currentTime = $('#video')[0].duration;
                            $('#video')[0].pause();
                            $('#skipBlanks').trigger('click');
                            setTimeout(() => {
                                $('#skipBlanks').trigger('click');
                            }, 1000);
                        }
                    }
                }

                // ÊéßÂà∂ÁÆÄÊòìËøõÂ∫¶Êù°
                let video = document.getElementById('video');
                let progressBar = document.getElementById('progress-bar');
                let progressBarTemp = document.getElementById('progress-bar-temp');
                let progressBarShade = document.getElementById('progress-bar-shade');
                let percentage = (video.currentTime / video.duration) * 100;

                let lastProgressBarWidth = parseFloat(window.getComputedStyle(progressBar).width);
                progressBar.style.width = percentage + '%';
                let currentProgressBarWidth = parseFloat(window.getComputedStyle(progressBar).width);

                function delayHideProgressBarTemp() {
                    if (hideProgressBarTempTimer) {
                        clearTimeout(hideProgressBarTempTimer)
                    }
                    hideProgressBarTempTimer = setTimeout(() => {
                        progressBarTemp.style.display = 'none';
                        progressBarShade.style.display = 'none';
                    }, 9000);
                }

                if (currentProgressBarWidth - lastProgressBarWidth > 20) {
                    progressBarTemp.style.display = 'block';
                    progressBarTemp.style.width = currentProgressBarWidth + 'px';
                    progressBarTemp.style.backgroundColor = 'red';
                    progressBarTemp.style.zIndex = 3;
                    progressBarShade.style.display = 'block';
                    progressBarShade.style.width = lastProgressBarWidth + 'px';
                    progressBarShade.style.zIndex = 4;
                    delayHideProgressBarTemp()
                } else if (lastProgressBarWidth - currentProgressBarWidth > 20) {
                    progressBarTemp.style.display = 'block';
                    progressBarTemp.style.width = lastProgressBarWidth + 'px';
                    progressBarTemp.style.backgroundColor = 'greenyellow';
                    progressBarTemp.style.zIndex = 1;
                    delayHideProgressBarTemp()
                }
            }

            // Listen for timeupdate event to highlight the subtitle
            $('#video').on('timeupdate', highlightSubtitle);
            $('#video').on('seeking', highlightSubtitle);



            function loadSubtitlesImpl() {
                subtitles = [];
                // Combine short subtitles
                let minLength = parseInt(document.getElementById("textLength").value, 10);
                var i = 0;
                while (i < tempSubtitles.length) {
                    var text = tempSubtitles[i].text;
                    var start = tempSubtitles[i].start;
                    var end = tempSubtitles[i].end;
                    while (i + 1 < tempSubtitles.length && text.length < minLength) {
                        i++;
                        text += "Ôºå" + tempSubtitles[i].text;
                        end = tempSubtitles[i].end;
                    }
                    // text += "„ÄÇ"
                    subtitles.push({ start: start, end: end, text: text });
                    $('#subtitles').append('<div class="subtitle" data-index="' + (subtitles.length - 1) + '">' + text + '</div>');
                    i++;
                }

                // Set up event listener for clicking on subtitles
                $('.subtitle').click(function () {
                    var index = $(this).data('index');
                    $('#video')[0].currentTime = subtitles[index].start;
                    if ($('#clickToPlay').prop('checked')) {
                        $('#video')[0].play();
                    }
                    $('#video')[0].focus();
                });
                $('#subtitles').css('width', window.innerWidth - $('#video-player').width() - $('#divider').width() + 'px');
            }

            function loadSubtitles(file, formatIsAss = false) {
                return new Promise((resolve, reject) => {
                    clearAllSub()
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        // Parse SRT file
                        var data = e.target.result;
                        if (formatIsAss) {
                            data = ass2srt(data)
                        }
                        var lines = data.split('\n');

                        tempSubtitles = []; // Store unprocessed subtitles

                        for (var i = 0; i < lines.length; i++) {
                            if (lines[i].indexOf('-->') !== -1) {
                                var times = lines[i].split(' --> ');
                                var start = hmsToSeconds(times[0].trim());
                                var end = hmsToSeconds(times[1].trim());
                                var text = "";
                                for (var j = i + 1; j < lines.length; j++) {
                                    if (lines[j].trim() === "") {
                                        i = j;
                                        break;
                                    }
                                    text += lines[j] + "\n";
                                }
                                tempSubtitles.push({ start: accTime(start), end: accTime(end), text: text.trim() });
                            }
                        }

                        loadSubtitlesImpl()
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }

            function hmsToSeconds(time) {
                time = time.replace('.', ',');
                var parts = time.split(':');
                var secondsParts = parts[2].split(",");
                var hours = parseInt(parts[0], 10);
                var minutes = parseInt(parts[1], 10);
                var seconds = parseInt(secondsParts[0], 10);
                var milliseconds = parseInt(secondsParts[1], 10);
                return hours * 3600 + minutes * 60 + seconds + milliseconds / 1000;
            }

            document.getElementById('fetchDufsFiles').addEventListener('click', function () {
                var dufsUrlElem = document.getElementById('dufsUrl');
                var dufsUrl = dufsUrlElem.value;
                if (!dufsUrl) {
                    dufsUrlElem.classList.add("blinking");
                    setTimeout(function () {
                        dufsUrlElem.classList.remove("blinking");
                    }, 500);
                    return
                }
                fetch(dufsUrl + '?simple')
                    .then(response => response.text())
                    .then(data => {
                        var files = data.split('\n');
                        var fileListHtml = files.map(file => {
                            if (file.toLowerCase().endsWith('.mp4') || file.toLowerCase().endsWith('.webm') || file.toLowerCase().endsWith('.json') || file.toLowerCase().endsWith('.srt') || file.toLowerCase().endsWith('.ass')) {
                                return `<label><input type="checkbox" name="file" value="${file}">${file}</label><br>`;
                            }
                        }).join('');
                        document.getElementById('fileList').innerHTML = fileListHtml;
                        document.getElementById('modalOverlay').style.display = 'block';
                    });
            });

            document.getElementById('loadSelectedFiles').addEventListener('click', async function () {
                srtLoaded = false
                var selectedFiles = document.querySelectorAll('input[name="file"]:checked');
                for (let file of selectedFiles) {
                    var fileUrl = formatDufsBaseUrl(document.getElementById('dufsUrl').value) + file.value;
                    if (fileUrl.toLowerCase().endsWith('.mp4') || fileUrl.toLowerCase().endsWith('.webm')) {
                        document.getElementById('video').src = fileUrl;
                        document.title = file.value;
                        $('#videoFileName').text(file.value);
                    } else {
                        try {
                            let response = await fetch(fileUrl);
                            let blob = await response.blob();

                            if (fileUrl.toLowerCase().endsWith('.srt')) {
                                srtLoaded = true;
                                await loadSubtitles(blob);
                            } else if (fileUrl.toLowerCase().endsWith('.ass')) {
                                srtLoaded = true;
                                await loadSubtitles(blob, formatIsAss = true);
                            } else if (fileUrl.toLowerCase().endsWith('.json')) {
                                if (!srtLoaded) {
                                    await loadSubtitlesFromJSON(blob);
                                }
                                loadDiarizationInfo(blob);
                            }

                        } catch (error) {
                            console.error("Fetch error: ", error);
                        }
                    }
                };
                document.getElementById('modalOverlay').style.display = 'none';
            });

            function formatDufsBaseUrl(url) {
                var baseUrl = url.split('?')[0];
                if (baseUrl[baseUrl.length - 1] !== '/') {
                    baseUrl += '/';
                }
                return baseUrl;
            }

            document.getElementById('closeFileList').addEventListener('click', function () {
                document.getElementById('modalOverlay').style.display = 'none';
            })

            $("#resizable-shade").resizable({
                handles: "all",
                classes: {
                    "ui-resizable-se": "ui-resizable-se-adjust-position",
                },
                containment: ".video_container"
            });
            $("#resizable-shade").draggable();

            var focusVideoTimer = null;
            (function () {
                let video = document.getElementById('video');
                let statusIcon = document.getElementById('videoFocusStatus');
                video.onblur = function () {
                    statusIcon.innerHTML = '‚ùå<span style="color: red;">Â§±ÁÑ¶</span>';
                    if (focusVideoTimer) {
                        clearTimeout(focusVideoTimer)
                    }
                    focusVideoTimer = setTimeout(function () {
                        video.focus();
                    }, 10000);
                };
                video.onfocus = function () {
                    if (focusVideoTimer) {
                        clearTimeout(focusVideoTimer)
                    }
                    statusIcon.innerHTML = '‚úîÔ∏è<span style="color: #00D26A;">ËÅöÁÑ¶</span>';
                }
            })();

            (function () {
                let video = document.getElementById('video');
                let statusIcon = document.getElementById('videoCanPlayStatus');
                video.oncanplay = () => {
                    statusIcon.innerText = 'üü°';
                    statusIcon.classList.add('blinking');
                }
                video.oncanplaythrough = () => {
                    statusIcon.innerText = 'üü¢';
                    statusIcon.classList.remove('blinking');
                }
                video.onwaiting = () => {
                    statusIcon.innerText = 'üî¥';
                    statusIcon.classList.add('blinking');
                }
                video.onseeking = () => {
                    statusIcon.innerText = 'üî¥';
                    statusIcon.classList.add('blinking');
                }
            })();

            document.getElementById("skipBlanks").addEventListener('click', function (event) {
                setTimeout(() => {
                    $('#video')[0].focus();
                }, 200);
            });

            $('#sideListSupHeight').on('input', function () {
                const subtitleImages = document.querySelectorAll('#subtitles .sup-subtitle-image');
                const value = parseInt(this.value, 10);
                subtitleImages.forEach(img => {
                    img.style.maxHeight = `${value}px`;
                });
            });

            document.getElementById('video').addEventListener('loadedmetadata', function () {
                const video = this;
                const duration = video.duration;
                const minutes = Math.round(duration / 60);
                document.getElementById('videoDurationInfo').innerHTML = `${minutes}<span id="videoDurationInfoMin">min</span>`;
            });

            document.getElementById('video').addEventListener('loadstart', function () {
                document.getElementById('videoDurationInfo').innerHTML = "‚è±Ô∏è";
            });

            $('#blurAllSub').change(function () {
                if ($(this).is(':checked')) {
                    $('.subtitle').addClass('censored');
                } else {
                    $('.subtitle').addClass('none-blur');
                    $('.subtitle').removeClass('censored');
                    setTimeout(() => {
                        $('.subtitle').removeClass('none-blur');
                    }, 500);
                }
            });

        });
    </script>
</body>

</html>